<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>车型详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <style>
        .noUi-connect {
            background: #3B82F6;
        }

        .noUi-handle {
            border-radius: 50%;
            box-shadow: none;
            border: 2px solid #3B82F6;
            background: #FFF;
            cursor: pointer;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .toggle-bg {
            transition: background-color 0.2s ease-in-out;
        }

        .toggle-knob {
            transition: transform 0.2s ease-in-out;
            transform: translateX(0);
        }

        input:checked + .toggle-bg {
            background-color: #3B82F6;
        }

        input:checked + .toggle-bg + .toggle-knob {
            transform: translateX(1rem);
        }

        textarea::placeholder {
            color: #9CA3AF;
            font-size: 1.125rem;
            line-height: 1.75rem;
        }

        @keyframes pulse {
            50% {
                opacity: 0.5;
            }
        }

        .skeleton-card {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        #autocomplete-results {
            position: absolute;
            z-index: 999;
            max-height: 320px;
            overflow-y: auto;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .favorite-btn.favorited svg {
            fill: currentColor;
        }

        .favorite-btn:not(.favorited) svg {
            fill: none;
        }

    </style>
</head>
<body class="bg-gray-100">

<div id="autocomplete-results"
     class="w-full bg-white border border-gray-300 rounded-b-lg shadow-lg text-left"
     style="display: none;">
</div>

<header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-50">
    <h1 class="text-3xl font-bold text-blue-600">驭·见</h1>
    <nav id="navbar-container" class="space-x-6 text-gray-700">
        <a href="车系.html" class="hover:text-blue-500">首页</a>
        <span class="text-gray-400">加载中...</span>
    </nav>
</header>
<section class="p-16 bg-center bg-cover text-white text-center"
         style="background-image: url('https://digitalassets.tesla.com/tesla-contents/image/upload/h_1800,w_2880,c_fit,f_auto,q_auto:best/Model-S-Exterior-Hero-Desktop-Global');">
    <h2 id="page-title" class="text-3xl font-semibold mb-4">正在加载车型...</h2>
    <div class="max-w-3xl mx-auto">
        <div class="relative w-full">
        <textarea id="search-input" rows="1" placeholder="在当前车系下搜索车型 (如: 40 TFSI)"
                  class="relative z-10 w-full p-4 pr-28 pb-14 text-lg text-gray-800 rounded-lg shadow-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
            <label for="ai-toggle" class="absolute z-20 bottom-3 left-4 flex items-center cursor-pointer">
                <div class="relative">
                    <input type="checkbox" id="ai-toggle" class="sr-only">
                    <div class="toggle-bg block w-10 h-6 bg-gray-400 rounded-full"></div>
                    <div class="toggle-knob absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div>
                </div>
                <span class="ml-2 text-gray-700 font-medium">AI 分析</span>
            </label>
            <button id="clear-search-button" title="清除内容"
                    class="absolute z-20 bottom-4 right-16 bg-gray-300 hover:bg-gray-400 text-gray-600 rounded-full w-8 h-8 flex items-center justify-center transition-colors"
                    style="display: none;">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <button id="search-button"
                    class="absolute z-20 bottom-3 right-4 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 rounded-full w-10 h-10 flex items-center justify-center transition-colors">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"></path>
                </svg>
            </button>
        </div>
    </div>
</section>

<section class="max-w-6xl mx-auto p-6 bg-white rounded-lg shadow mt-6 relative z-10">
    <div class="space-y-4">
        <div class="flex items-center space-x-4">
            <span class="font-semibold text-gray-700 w-20">价格区间:</span>
            <div class="flex-grow pt-3 px-2">
                <div id="price-slider"></div>
            </div>
            <div class="flex items-center space-x-2 w-auto flex-shrink-0">
                <input type="number" id="price-min-input" class="w-20 p-1 border rounded text-center"
                       placeholder="最低价">
                <span class="text-gray-500">-</span>
                <input type="number" id="price-max-input" class="w-20 p-1 border rounded text-center"
                       placeholder="最高价">
                <span class="text-gray-500">万</span>
            </div>
            <button id="price-100-plus-btn"
                    class="ml-2 px-4 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-full flex-shrink-0">
                100万以上
            </button>
        </div>
        <div class="pt-4 mt-4 border-t">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="filter-power-type" class="block text-sm font-medium text-gray-700">动力类型</label>
                    <select id="filter-power-type" data-filter-key="power_type"
                            class="filter-select mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="不限">不限</option>
                        <option value="纯电">纯电</option>
                        <option value="插电混动">插电混动</option>
                        <option value="增程式">增程式</option>
                        <option value="燃油">燃油</option>
                        <option value="油电混合">油电混合</option>
                        <option value="轻混系统">轻混系统</option>
                    </select>
                </div>
                <div>
                    <label for="filter-body-type" class="block text-sm font-medium text-gray-700">车身类型</label>
                    <select id="filter-body-type" data-filter-key="body_type"
                            class="filter-select mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="不限">不限</option>
                        <option value="SUV">SUV</option>
                        <option value="MPV">MPV</option>
                        <option value="轿车">轿车</option>
                        <option value="跑车">跑车</option>
                        <option value="皮卡">皮卡</option>
                        <option value="旅行车">旅行车</option>
                        <option value="掀背车">掀背车</option>
                        <option value="敞篷车">敞篷车</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div>
                    <label for="filter-seat-count" class="block text-sm font-medium text-gray-700">座位数</label>
                    <select id="filter-seat-count" data-filter-key="seat_count"
                            class="filter-select mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="不限">不限</option>
                        <option value="2座">2座</option>
                        <option value="4座">4座</option>
                        <option value="5座">5座</option>
                        <option value="6座">6座</option>
                        <option value="7座">7座</option>
                    </select>
                </div>
                <div>
                    <label for="filter-segment" class="block text-sm font-medium text-gray-700">车辆级别</label>
                    <select id="filter-segment" data-filter-key="segment"
                            class="filter-select mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="不限">不限</option>
                        <option value="小型">小型</option>
                        <option value="紧凑型">紧凑型</option>
                        <option value="中型">中型</option>
                        <option value="中大型">中大型</option>
                        <option value="大型">大型</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="ai-summary-section" class="max-w-6xl mx-auto p-6 bg-white rounded-lg shadow mt-6">
    <div id="ai-summary-trigger" class="flex justify-between items-center cursor-pointer">
        <h3 class="text-2xl font-bold text-gray-800">AI 口碑智能总结</h3>
        <button id="ai-summary-toggle-button"
                class="text-blue-600 hover:text-blue-800 font-semibold py-1 px-3 rounded-lg">
            点此查看 &darr;
        </button>
    </div>
    <div id="ai-summary-container" class="mt-6 border-t pt-6" style="display: none;">
        <div id="ai-summary-loading" class="animate-pulse-slow" style="display: none;">
            <p class="text-center text-gray-500 mb-4">AI总结生成中，请稍候...</p>
            <div class="h-4 bg-gray-200 rounded w-1/4 mb-4"></div>
            <div class="space-y-3">
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
            </div>
        </div>
        <div id="ai-summary-stats" class="mb-4" style="display: none;">
        </div>
        <div id="ai-summary-content" class="text-gray-700 leading-relaxed whitespace-pre-line" style="display: none;">
        </div>
        <div id="ai-summary-error" class="text-red-500" style="display: none;">
        </div>
    </div>
</section>

<main class="max-w-6xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <p class="text-gray-600">共为您找到 <span id="total-hits" class="font-bold text-blue-600">0</span> 款相关车型
        </p>
    </div>
    <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="pagination-container" class="mt-10 flex justify-center items-center space-x-2"></div>
</main>

<footer class="bg-gray-800 text-gray-300 text-center py-6 mt-10">
    © 2025 驭见 智能车辆搜索引擎 | 数据来源：易车
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
<script src="config.js"></script>
<script>

    let currentPage = 1;
    const itemsPerPage = 12;
    let seriesName = '';
    let filters = {
        q: '',
        price_min: 0,
        price_max: 0,
        power_type: '不限',
        body_type: '不限',
        seat_count: '不限',
        segment: '不限'
    };
    let aiSummaryLoaded = false;
    let aiSummaryLoading = false;

    let isUserLoggedIn = false;
    let userFavoritesList = [];

    function setupNavbar() {
        const navbarContainer = document.getElementById('navbar-container');
        if (!navbarContainer) return;
        const nickname = localStorage.getItem('userNickname');
        const role = localStorage.getItem('userRole');
        let adminLinkHTML = '';
        if (role === 'admin' || role === 'core_admin') {
            adminLinkHTML = '<a href="admin.html" class="font-medium text-purple-600 hover:underline">管理后台</a>';
        }
        if (nickname) {
            navbarContainer.innerHTML = `
                <a href="车系.html" id="reset-homepage-link" class="hover:text-blue-500">首页</a>
                <a href="favorites.html" class="hover:text-blue-500">我的收藏</a>
                <a href="compare.html" class="hover:text-blue-500">车型对比</a>
                <a href="javascript:history.back()" id="nav-back-link" class="hover:text-blue-500">&larr; 返回</a>
                <a href="about.html" class="hover:text-blue-500">关于</a>
                ${adminLinkHTML}<span class="font-semibold text-gray-700">欢迎, ${nickname}</span>
                <a href="profile.html" class="hover:text-blue-500">账户设置</a>
                <button id="logout-button-nav" class="text-gray-600 hover:text-red-500">退出登录</button>
            `;
            const logoutButton = document.getElementById('logout-button-nav');
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }
        } else {
            navbarContainer.innerHTML = `
                <a href="车系.html" id="reset-homepage-link" class="hover:text-blue-500">首页</a>
                <a href="favorites.html" class="hover:text-blue-500">我的收藏</a>
                <a href="compare.html" class="hover:text-blue-500">车型对比</a>
                <a href="javascript:history.back()" id="nav-back-link" class="hover:text-blue-500">&larr; 返回</a>
                <a href="about.html" class="hover:text-blue-500">关于</a>
                <a href="login.html" class="font-medium text-blue-600 hover:underline">登录</a>
                <a href="register.html" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">注册</a>
            `;
        }
    }

    async function handleLogout() {
        localStorage.removeItem('userNickname');
        localStorage.removeItem('userRole');
        try {
            await fetch(`${API_BASE_URL}/auth/logout`, {
                method: 'POST',
                credentials: 'include'
            });
        } catch (error) {
            console.error("退出登录请求失败 (不影响本地退出):", error);
        }
        window.location.reload();
    }

    async function loadUserFavorites() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/favorites`, {
                method: 'GET',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'}
            });

            if (response.status === 200) {
                userFavoritesList = await response.json();
                isUserLoggedIn = true;
                console.log("用户收藏列表加载成功:", userFavoritesList);
            } else {
                isUserLoggedIn = false;
                userFavoritesList = [];
                console.log("用户未登录或获取收藏失败。");
            }
        } catch (e) {
            console.error("无法连接到收藏夹API:", e);
            isUserLoggedIn = false;
            userFavoritesList = [];
        }
    }

    async function apiAddFavorite(modelId, seriesName) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/favorites/add`, {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model_id: modelId, series_name: seriesName})
            });
            if (!response.ok) return false;
            userFavoritesList.push({id: modelId, series: seriesName});
            return true;
        } catch (e) {
            console.error("添加收藏失败:", e);
            return false;
        }
    }

    async function apiRemoveFavorite(modelId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/favorites/remove`, {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model_id: modelId})
            });
            if (!response.ok) return false;
            userFavoritesList = userFavoritesList.filter(item => item.id !== modelId);
            return true;
        } catch (e) {
            console.error("移除收藏失败:", e);
            return false;
        }
    }

    async function handleFavoriteClick(buttonEl) {

        if (!isUserLoggedIn) {
            alert("请先登录后再使用收藏功能。");
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
            return;
        }

        const modelId = decodeURIComponent(buttonEl.dataset.modelId);
        const seriesName = decodeURIComponent(buttonEl.dataset.seriesName);

        const isFavorited = userFavoritesList.some(item => item.id === modelId);

        const favIconFavorited = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>';
        const favIconRegular = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>';

        if (isFavorited) {

            buttonEl.title = '加入收藏';
            buttonEl.classList.remove('favorited', 'text-red-500', 'bg-red-100', 'hover:bg-red-200');
            buttonEl.classList.add('text-gray-400', 'hover:text-red-500', 'hover:bg-red-100');
            buttonEl.innerHTML = favIconRegular;

            const success = await apiRemoveFavorite(modelId);
            if (!success) {
                buttonEl.title = '移除收藏';
                buttonEl.classList.add('favorited', 'text-red-500', 'bg-red-100', 'hover:bg-red-200');
                buttonEl.classList.remove('text-gray-400', 'hover:text-red-500', 'hover:bg-red-100');
                buttonEl.innerHTML = favIconFavorited;
            }
        } else {
            buttonEl.title = '移除收藏';
            buttonEl.classList.add('favorited', 'text-red-500', 'bg-red-100', 'hover:bg-red-200');
            buttonEl.classList.remove('text-gray-400', 'hover:text-red-500', 'hover:bg-red-100');
            buttonEl.innerHTML = favIconFavorited;

            const success = await apiAddFavorite(modelId, seriesName);
            if (!success) {
                buttonEl.title = '加入收藏';
                buttonEl.classList.remove('favorited', 'text-red-500', 'bg-red-100', 'hover:bg-red-200');
                buttonEl.classList.add('text-gray-400', 'hover:text-red-500', 'hover:bg-red-100');
                buttonEl.innerHTML = favIconRegular;
            }
        }
    }

    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function positionAutocomplete() {
        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('autocomplete-results');
        if (resultsContainer.style.display === 'block') {
            const rect = searchInput.getBoundingClientRect();
            resultsContainer.style.top = `${window.scrollY + rect.bottom}px`;
            resultsContainer.style.left = `${rect.left}px`;
            resultsContainer.style.width = `${rect.width}px`;
        }
    }

    async function fetchAutocomplete(query) {
        const resultsContainer = document.getElementById('autocomplete-results');
        const aiToggle = document.getElementById('ai-toggle');
        if (!seriesName || query.length < 1 || aiToggle.checked) {
            resultsContainer.style.display = 'none';
            return;
        }
        try {
            const url = `${API_BASE_URL}/search-models?q=${encodeURIComponent(query)}&series_name=${encodeURIComponent(seriesName)}`;
            const response = await fetch(url);
            if (!response.ok) {
                resultsContainer.style.display = 'none';
                return;
            }
            const data = await response.json();
            if (data.length === 0) {
                resultsContainer.innerHTML = '<div class="p-3 text-gray-500 text-sm">在此车系中未找到匹配项</div>';
            } else {
                let html = data.map(model => {
                    const modelName = model['车型名称'];
                    return `
                        <div class="p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-100 autocomplete-item"
                             data-completion-text="${modelName}">
                            <span class="font-medium text-gray-800">${modelName}</span>
                            <span class="text-xs text-gray-500 block">${model['基本信息_厂商指导价'] || ''}</span>
                        </div>
                    `;
                }).join('');
                resultsContainer.innerHTML = html;
            }
            resultsContainer.style.display = 'block';
            positionAutocomplete();
        } catch (e) {
            console.error("Autocomplete fetch failed:", e);
            resultsContainer.style.display = 'none';
        }
    }

    function renderLoadingSkeletons(count) {
        const resultsGrid = document.getElementById('results-grid');
        let skeletonHTML = '';
        for (let i = 0; i < count; i++) {
            skeletonHTML += `
            <div class="skeleton-card bg-white shadow rounded-lg p-4">
              <div class="rounded-lg mb-3 h-48 w-full object-cover bg-gray-200"></div>
              <div class="h-6 rounded bg-gray-200 w-3/4 mb-2"></div>
              <div class="flex flex-wrap gap-2 text-xs mb-3">
                <div class="h-4 rounded-full bg-gray-200 w-16"></div>
                <div class="h-4 rounded-full bg-gray-200 w-20"></div>
                <div class="h-4 rounded-full bg-gray-200 w-12"></div>
              </div>
              <div class="h-5 rounded bg-gray-200 w-24 mt-2"></div>
            </div>
            `;
        }
        resultsGrid.innerHTML = skeletonHTML;
    }

    function fetchAiSummary(currentSeriesName, currentFilters) {
        if (aiSummaryLoading) return;
        aiSummaryLoading = true;
        const loadingEl = document.getElementById('ai-summary-loading');
        const statsEl = document.getElementById('ai-summary-stats');
        const contentEl = document.getElementById('ai-summary-content');
        const errorEl = document.getElementById('ai-summary-error');
        contentEl.style.display = 'none';
        statsEl.style.display = 'none';
        statsEl.innerHTML = '';
        errorEl.style.display = 'none';
        loadingEl.style.display = 'block';
        const url = new URL(`${API_BASE_URL}/get-review-summary`);
        url.searchParams.append('series_name', currentSeriesName);
        url.searchParams.append('filters', JSON.stringify(currentFilters));
        fetch(url)
            .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err.error || 'AI总结服务暂时不可用')))
            .then(data => {
                if (data.error) throw new Error(data.error);
                let statsHTML = '';
                if (data.average_rating && data.review_count) {
                    statsHTML = `
                    <div class="flex items-center justify-center space-x-6 mb-4">
                        <div class="text-center">
                            <span class="text-4xl font-bold text-yellow-500">${data.average_rating.toFixed(1)}</span>
                            <span class="text-lg text-gray-600"> / 5</span>
                            <p class="text-sm text-gray-500">综合平均分</p>
                        </div>
                        <div class="border-l h-12 border-gray-300"></div>
                        <div class="text-center">
                            <span class="text-4xl font-bold text-blue-600">${data.review_count}</span>
                            <p class="text-sm text-gray-500">位车主评价</p>
                        </div>
                    </div>
                    <div class="border-b my-4"></div>
                `;
                }
                statsEl.innerHTML = statsHTML;
                statsEl.style.display = 'block';
                contentEl.textContent = data.summary_text;
                contentEl.style.display = 'block';
                aiSummaryLoaded = true;
            })
            .catch(error => {
                const errorMessage = (error instanceof Error) ? error.message : String(error);
                errorEl.textContent = `AI总结加载失败: ${errorMessage}`;
                errorEl.style.display = 'block';
                aiSummaryLoaded = true;
            })
            .finally(() => {
                loadingEl.style.display = 'none';
                aiSummaryLoading = false;
            });
    }

    function fetchAndRenderModels() {
        if (!seriesName) return;
        const url = new URL(`${API_BASE_URL}/details`);
        url.searchParams.append('series_name', seriesName);
        url.searchParams.append('page', currentPage);
        url.searchParams.append('per_page', itemsPerPage);
        for (const key in filters) {
            if (filters[key] && filters[key] !== '不限' && filters[key] !== 0) {
                url.searchParams.append(key, filters[key]);
            }
        }
        renderLoadingSkeletons(itemsPerPage);
        aiSummaryLoaded = false;
        document.getElementById('ai-summary-content').style.display = 'none';
        document.getElementById('ai-summary-stats').style.display = 'none';
        document.getElementById('ai-summary-error').style.display = 'none';
        const summaryContainer = document.getElementById('ai-summary-container');
        if (summaryContainer.style.display === 'block' && !aiSummaryLoading) {
            fetchAiSummary(seriesName, filters);
        }
        fetch(url)
            .then(response => response.ok ? response.json() : Promise.reject(`网络错误: ${response.status}`))
            .then(data => {
                if (data.error) throw new Error(data.error);
                renderModelCards(data.hits || []); // <-- 修改：现在使用全局收藏列表
                renderPagination(data.total || 0, data.per_page || itemsPerPage);
                document.getElementById('total-hits').textContent = data.total || 0;
                updateFilterUIFromState();
            })
            .catch(error => {
                console.error('获取车型数据失败:', error);
                const errorMessage = error.message || error;
                document.getElementById('results-grid').innerHTML = `<p class="text-red-500 col-span-full">车型数据加载失败: ${errorMessage}</p>`;
            });
    }

    function renderModelCards(models) {
        const resultsGrid = document.getElementById('results-grid');

        if (models.length === 0) {
            resultsGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
              <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10l.01.01" />
              </svg>
              <h3 class="mt-2 text-xl font-semibold text-gray-800">未找到相关车型</h3>
              <p class="mt-1 text-gray-500">请尝试减少筛选条件或更换关键词。</p>
            </div>
            `;
            return;
        }

        resultsGrid.innerHTML = '';
        const currentSeriesName = seriesName || '';

        models.forEach(model => {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = "bg-white shadow rounded-lg p-4 flex flex-col justify-between relative transition-transform hover:scale-105";

            const modelId = model['车型名称'] || '未知车型';
            const seriesId = currentSeriesName;
            const configUrl = `configDetails.html?model_id=${encodeURIComponent(modelId)}&series_name=${encodeURIComponent(seriesId)}&model_name=${encodeURIComponent(modelId)}`;

            const powerType = model['动力类型'] || '未知';
            let colorClass = 'bg-gray-100 text-gray-800';
            if (powerType === '纯电') colorClass = 'bg-green-100 text-green-800';
            else if (['插电混动', '增程式'].includes(powerType)) colorClass = 'bg-blue-100 text-blue-800';
            else if (['燃油', '油电混合', '轻混系统'].includes(powerType)) colorClass = 'bg-red-100 text-red-800';

            const seatCount = model['车身_座位数'];
            const segment = model['基本信息_级别'];

            const isFavorited = userFavoritesList.some(item => item.id === modelId);

            let favBtnHTML;

            if (!isUserLoggedIn) {
                favBtnHTML = `
                    <a href="login.html?redirect=${encodeURIComponent(window.location.href)}"
                       title="登录以收藏"
                       class="favorite-btn p-2 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                    </a>
                 `;
            } else {
                const favBtnClasses = isFavorited
                    ? 'favorite-btn p-2 rounded-full text-red-500 bg-red-100 hover:bg-red-200 favorited'
                    : 'favorite-btn p-2 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-100';
                const favIcon = isFavorited
                    ? '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>'
                    : '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>';
                const favTitle = isFavorited ? '移除收藏' : '加入收藏';

                favBtnHTML = `
                    <button class="${favBtnClasses}"
                            data-model-id="${encodeURIComponent(modelId)}"
                            data-series-name="${encodeURIComponent(seriesId)}"
                            title="${favTitle}">
                        ${favIcon}
                    </button>
                 `;
            }

            cardWrapper.innerHTML = `
                <div>
                  <a href="${configUrl}">
                    <img src="${model['图片链接'] || 'https://via.placeholder.com/400x300.png?text=No+Image'}" alt="${model['车型名称']}" class="rounded-lg mb-3 h-48 w-full object-cover">
                  </a>
                  <a href="${configUrl}">
                    <h3 class="text-xl font-semibold mb-2">${model['车型名称']}</h3>
                  </a>
                  <div class="flex flex-wrap gap-2 text-xs mb-3">
                      <span class="${colorClass} font-medium px-2.5 py-0.5 rounded-full">${powerType}</span>
                      <span class="bg-gray-100 text-gray-800 font-medium px-2.5 py-0.5 rounded-full">${model['基本信息_厂商指导价'] || '价格未知'}</span>
                      <span class="bg-yellow-100 text-yellow-800 font-medium px-2.5 py-0.5 rounded-full">${model['车身类型'] || '类型未知'}</span>
                      ${seatCount ? `<span class="bg-purple-100 text-purple-800 font-medium px-2.5 py-0.5 rounded-full">${seatCount}</span>` : ''}
                      ${segment ? `<span class="bg-indigo-100 text-indigo-800 font-medium px-2.5 py-0.5 rounded-full">${segment}</span>` : ''}
                  </div>
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <a href="${configUrl}" class="text-blue-500 hover:underline font-semibold self-start mt-2">
                        查看配置详情 &rarr;
                    </a>
                    ${favBtnHTML} </div>
            `;
            resultsGrid.appendChild(cardWrapper);
        });
    }

    function renderPagination(totalItems, perPage) {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        if (!perPage || perPage <= 0) perPage = itemsPerPage;
        const totalPages = Math.ceil(totalItems / perPage);
        if (totalPages <= 1) return;
        const createButton = (text, page, isDisabled = false, isActive = false) => {
            const button = document.createElement('button');
            button.innerHTML = text;
            button.disabled = isDisabled;
            button.className = `px-4 py-2 text-sm rounded-md ${isActive ? 'bg-blue-500 text-white' : 'bg-white border hover:bg-gray-100'} ${isDisabled ? 'cursor-not-allowed opacity-50' : ''}`;
            if (!isDisabled) {
                button.onclick = () => {
                    currentPage = page;
                    fetchAndRenderModels();
                    window.scrollTo(0, 0);
                };
            }
            return button;
        };
        paginationContainer.appendChild(createButton('上一页', currentPage - 1, currentPage === 1));
        let hasStartEllipsis = false;
        let hasEndEllipsis = false;
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                paginationContainer.appendChild(createButton(i, i, false, i === currentPage));
            } else if (i < currentPage - 2 && !hasStartEllipsis) {
                paginationContainer.insertAdjacentHTML('beforeend', `<span class="px-2">...</span>`);
                hasStartEllipsis = true;
            } else if (i > currentPage + 2 && !hasEndEllipsis) {
                paginationContainer.insertAdjacentHTML('beforeend', `<span class="px-2">...</span>`);
                hasEndEllipsis = true;
            }
        }
        paginationContainer.appendChild(createButton('下一页', currentPage + 1, currentPage === totalPages));
        const jumpHTML = `
            <span class="ml-4 text-sm text-gray-600">共 ${totalPages} 页，跳至</span>
            <input type="number" id="page-jump-input" class="w-16 p-2 border rounded text-center text-sm" min="1" max="${totalPages}" placeholder="页码">
            <button id="page-jump-btn" class="ml-2 px-4 py-2 text-sm rounded-md bg-white border hover:bg-gray-100">跳转</button>
        `;
        paginationContainer.insertAdjacentHTML('beforeend', jumpHTML);
        const jumpButton = document.getElementById('page-jump-btn');
        const jumpInput = document.getElementById('page-jump-input');
        const handleJump = () => {
            let page = parseInt(jumpInput.value);
            if (!isNaN(page) && page >= 1 && page <= totalPages) {
                currentPage = page;
                fetchAndRenderModels();
                window.scrollTo(0, 0);
            } else {
                alert(`请输入 1 到 ${totalPages} 之间的有效页码`);
                jumpInput.value = '';
            }
        };
        if (jumpButton) jumpButton.addEventListener('click', handleJump);
        if (jumpInput) jumpInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') handleJump();
        });
    }

    function updateFilterUIFromState() {
        if (!filters) return;
        document.querySelectorAll('.filter-select').forEach(select => {
            const filterKey = select.dataset.filterKey;
            if (filters[filterKey]) {
                select.value = filters[filterKey];
            } else {
                select.value = '不限';
            }
        });
        const searchInput = document.getElementById('search-input');
        const clearSearchButton = document.getElementById('clear-search-button');
        if (searchInput) {
            searchInput.value = filters.q || '';
        }
        if (clearSearchButton) {
            if (filters.q && filters.q.length > 0) {
                clearSearchButton.style.display = 'flex';
            } else {
                clearSearchButton.style.display = 'none';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', async function () { // <-- 设为 async
        setupNavbar();
        const backLink = document.getElementById('nav-back-link');
        if (backLink) {
            if (document.referrer && document.referrer.includes('configDetails.html')) {
                backLink.onclick = function (e) {
                    e.preventDefault();
                    history.go(-3);
                };
            } else {
            }
        }
        await loadUserFavorites();
        seriesName = new URLSearchParams(window.location.search).get('series_name');
        if (seriesName) {
            const decodedName = decodeURIComponent(seriesName);
            document.title = `${decodedName} - 车型列表`;
            document.getElementById('page-title').textContent = `${decodedName}`;
            const navLinks = document.getElementById('navbar-container').querySelectorAll('a');

            navLinks.forEach(link => {

                if (link.href.includes('javascript:history.back()')) {
                }
            });
        } else {
            document.getElementById('page-title').textContent = '错误';
            document.getElementById('results-grid').innerHTML = '<p class="col-span-full text-red-500">未指定车系，无法查询车型。</p>';
            document.getElementById('ai-summary-section').style.display = 'none';
            return;
        }

        const priceSlider = document.getElementById('price-slider');
        const priceMinInput = document.getElementById('price-min-input');
        const priceMaxInput = document.getElementById('price-max-input');
        const btn100Plus = document.getElementById('price-100-plus-btn');
        noUiSlider.create(priceSlider, {
            start: [0, 100], connect: true,
            range: {'min': 0, 'max': 100}, step: 1,
            format: {to: v => Math.round(v), from: v => Number(v)}
        });
        priceSlider.noUiSlider.on('update', values => {
            const [min, max] = values;
            if (document.activeElement !== priceMinInput) priceMinInput.value = (min > 0) ? min : '';
            if (document.activeElement !== priceMaxInput) priceMaxInput.value = (max === 100) ? '' : max;
        });
        priceSlider.noUiSlider.on('change', values => {
            const [min, max] = values;
            btn100Plus.classList.remove('bg-blue-500', 'text-white');
            btn100Plus.classList.add('bg-gray-200', 'hover:bg-gray-300');
            filters.price_min = min;
            filters.price_max = (max === 100) ? 0 : max;
            currentPage = 1;
            fetchAndRenderModels();
        });

        function syncInputsToSlider() {
            btn100Plus.classList.remove('bg-blue-500', 'text-white');
            btn100Plus.classList.add('bg-gray-200', 'hover:bg-gray-300');
            let minVal = priceMinInput.value === '' ? 0 : parseInt(priceMinInput.value);
            let maxVal = priceMaxInput.value === '' ? 100 : parseInt(priceMaxInput.value);
            minVal = isNaN(minVal) || minVal < 0 ? 0 : minVal;
            maxVal = isNaN(maxVal) || maxVal < 0 ? 100 : maxVal;
            if (minVal > 100) minVal = 100;
            if (maxVal > 100) maxVal = 100;
            if (minVal > maxVal) maxVal = minVal;
            priceSlider.noUiSlider.set([minVal, maxVal], false);
            filters.price_min = minVal;
            filters.price_max = (maxVal === 100) ? 0 : maxVal;
            currentPage = 1;
            fetchAndRenderModels();
        }

        priceMinInput.addEventListener('change', syncInputsToSlider);
        priceMaxInput.addEventListener('change', syncInputsToSlider);
        btn100Plus.addEventListener('click', () => {
            filters.price_min = 100;
            filters.price_max = 0;
            priceSlider.noUiSlider.set([100, 100]);
            priceMinInput.value = 100;
            priceMaxInput.value = '';
            btn100Plus.classList.add('bg-blue-500', 'text-white');
            btn100Plus.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            currentPage = 1;
            fetchAndRenderModels();
        });

        document.querySelectorAll('.filter-select').forEach(select => {
            select.addEventListener('change', e => {
                const filterKey = e.target.dataset.filterKey;
                const filterValue = e.target.value;
                filters[filterKey] = filterValue;
                currentPage = 1;
                fetchAndRenderModels();
            });
        });

        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('search-input');
        const aiToggle = document.getElementById('ai-toggle');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const clearSearchButton = document.getElementById('clear-search-button');
        const handleSearchOrAI = () => {
            const query = searchInput.value.trim();
            autocompleteResults.style.display = 'none';
            if (aiToggle.checked) {
                const decodedSeriesName = decodeURIComponent(seriesName);
                const basePrompt = query ? query : `介绍一下${decodedSeriesName}这个车系`;
                const targetUrl = `second.html?initial_prompt=${encodeURIComponent(basePrompt)}&known_series=${encodeURIComponent(decodedSeriesName)}`;
                window.location.href = targetUrl;
            } else {
                filters.q = query;
                currentPage = 1;
                fetchAndRenderModels();
            }
        };
        aiToggle.addEventListener('change', () => {
            if (aiToggle.checked) {
                searchInput.placeholder = "针对当前车系提问 (如: 对比40和45 TFSI)";
                autocompleteResults.style.display = 'none';
            } else {
                searchInput.placeholder = "在当前车系下搜索车型 (如: 40 TFSI)";
            }
        });
        searchButton.onclick = handleSearchOrAI;
        searchInput.onkeydown = e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSearchOrAI();
            }
        };
        const debouncedFetch = debounce(fetchAutocomplete, 300);
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim();
            debouncedFetch(query);
            if (query.length > 0) {
                clearSearchButton.style.display = 'flex';
            } else {
                clearSearchButton.style.display = 'none';
            }
        });
        window.addEventListener('resize', positionAutocomplete);
        window.addEventListener('scroll', positionAutocomplete);
        searchInput.addEventListener('blur', () => {
            setTimeout(() => {
                autocompleteResults.style.display = 'none';
            }, 200);
        });
        searchInput.addEventListener('focus', () => {
            if (searchInput.value.trim().length > 0) {
                debouncedFetch(searchInput.value.trim());
            }
        });
        autocompleteResults.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const item = e.target.closest('.autocomplete-item');
            if (item) {
                const completionText = item.dataset.completionText;
                if (completionText) {
                    searchInput.value = completionText;
                    autocompleteResults.style.display = 'none';
                    filters.q = completionText;
                    currentPage = 1;
                    fetchAndRenderModels();
                    clearSearchButton.style.display = 'flex';
                }
            }
        });
        clearSearchButton.addEventListener('click', () => {
            searchInput.value = '';
            filters.q = '';
            clearSearchButton.style.display = 'none';
            autocompleteResults.style.display = 'none';
            searchInput.focus();
        });

        const summaryTrigger = document.getElementById('ai-summary-trigger');
        const summaryContainer = document.getElementById('ai-summary-container');
        const summaryButton = document.getElementById('ai-summary-toggle-button');
        if (summaryTrigger && summaryContainer && summaryButton) {
            summaryTrigger.addEventListener('click', () => {
                const isHidden = summaryContainer.style.display === 'none';
                if (isHidden) {
                    summaryContainer.style.display = 'block';
                    summaryButton.innerHTML = '收起总结 &uarr;';
                    if (!aiSummaryLoaded && !aiSummaryLoading) {
                        fetchAiSummary(seriesName, filters);
                    }
                } else {
                    summaryContainer.style.display = 'none';
                    summaryButton.innerHTML = '点此查看 &darr;';
                }
            });
        }


        document.getElementById('results-grid').addEventListener('click', (e) => {
            const favButton = e.target.closest('.favorite-btn');
            if (favButton && favButton.tagName === 'BUTTON') {
                e.preventDefault();
                e.stopPropagation();
                handleFavoriteClick(favButton);
            }
        });
        updateFilterUIFromState();
        fetchAndRenderModels();
    });
</script>
</body>
</html>