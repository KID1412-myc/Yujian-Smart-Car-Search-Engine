<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>智能车辆搜索引擎</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <style>
        .noUi-connect {
            background: #3B82F6;
        }

        .noUi-handle {
            border-radius: 50%;
            box-shadow: none;
            border: 2px solid #3B82F6;
            background: #FFF;
            cursor: pointer;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        #brand-modal {
            display: none;
            position: absolute;
            z-index: 100;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 600px;
            height: 400px;
            overflow: hidden;
        }

        .alpha-nav {
            background-color: #f9fafb;
            padding: 8px 4px;
            height: 100%;
            overflow-y: auto;
        }

        .alpha-nav button {
            display: block;
            width: 100%;
            padding: 4px;
            text-align: center;
            font-weight: 500;
            color: #4b5563;
            border-radius: 0.25rem;
        }

        .alpha-nav button:hover {
            background-color: #f3f4f6;
        }

        .alpha-nav button.active {
            background-color: #3b82f6;
            color: white;
        }

        .list-container {
            overflow-y: auto;
            height: 100%;
            padding: 8px;
        }

        .list-item {
            padding: 8px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
        }

        .list-item:hover {
            background-color: #f9fafb;
        }

        .list-item.all-option {
            font-weight: bold;
            color: #3b82f6;
        }

        .list-item.is-open {
            background-color: #eff6ff;
            color: #2563eb;
            font-weight: 600;
        }

        .manufacturer-sublist {
            padding-left: 24px;
            background-color: #f9fafb;
        }

        .manufacturer-sublist .list-item {
            border-top: 1px solid #e5e7eb;
            border-bottom: none;
        }

        .manufacturer-sublist .list-item:first-child {
            border-top: none;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .toggle-bg {
            transition: background-color 0.2s ease-in-out;
        }

        .toggle-knob {
            transition: transform 0.2s ease-in-out;
            transform: translateX(0);
        }

        input:checked + .toggle-bg {
            background-color: #3B82F6; /* blue-500 */
        }

        input:checked + .toggle-bg + .toggle-knob {
            transform: translateX(1rem); /* 16px */
        }

        textarea::placeholder {
            color: #9CA3AF; /* gray-400 */
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75rem;
        }

        @keyframes pulse {
            50% {
                opacity: 0.5;
            }
        }

        .skeleton-card {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        #autocomplete-results {
            position: absolute;
            z-index: 999;
            max-height: 320px;
            overflow-y: auto;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-separator {
            border-top: 2px solid #f3f4f6; /* gray-100 */
            margin-top: 4px;
            padding-top: 4px;
        }
    </style>
</head>
<body class="bg-gray-100">

<div id="autocomplete-results"
     class="w-full bg-white border border-gray-300 rounded-b-lg shadow-lg text-left"
     style="display: none;">
</div>

<header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-50">
    <h1 class="text-3xl font-bold text-blue-600">驭·见</h1>
    <nav id="navbar-container" class="space-x-6 text-gray-700">
        <a href="车系.html" class="font-bold text-blue-600 hover:underline">首页</a>
        <a href="favorites.html" class="hover:text-blue-500">我的收藏</a>
        <a href="compare.html" class="hover:text-blue-500">车型对比</a>
        <a href="login.html" class="font-medium text-blue-600 hover:underline">登录</a>
        <a href="register.html" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">注册</a>
    </nav>
</header>

<section class="p-16 bg-center bg-cover text-white text-center"
         style="background-image: url('https://digitalassets.tesla.com/tesla-contents/image/upload/h_1800,w_2880,c_fit,f_auto,q_auto:best/Model-S-Exterior-Hero-Desktop-Global');">
    <h2 class="text-3xl font-semibold mb-4">找到适合你的爱车</h2>

    <div class="max-w-3xl mx-auto">
        <div class="relative w-full">

        <textarea id="search-input"
                  rows="1"
                  placeholder="传统搜索 (如 奥迪A4L)"
                  class="relative z-10 w-full p-4 pr-28 pb-14 text-lg text-gray-800 rounded-lg shadow-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>

            <label for="ai-toggle" class="absolute z-20 bottom-3 left-4 flex items-center cursor-pointer">
                <div class="relative">
                    <input type="checkbox" id="ai-toggle" class="sr-only">
                    <div class="toggle-bg block w-10 h-6 bg-gray-400 rounded-full"></div>
                    <div class="toggle-knob absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div>
                </div>
                <span class="ml-2 text-gray-700 font-medium">AI 推荐</span>
            </label>

            <button id="clear-search-button"
                    title="清除内容"
                    class="absolute z-20 bottom-4 right-16 bg-gray-300 hover:bg-gray-400 text-gray-600 rounded-full w-8 h-8 flex items-center justify-center transition-colors"
                    style="display: none;">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>

            <button id="search-button"
                    class="absolute z-20 bottom-3 right-4 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 rounded-full w-10 h-10 flex items-center justify-center transition-colors">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"></path>
                </svg>
            </button>
        </div>
    </div>

</section>

<section class="max-w-6xl mx-auto p-6 bg-white rounded-lg shadow mt-6 relative z-10">
    <div class="space-y-4">
        <div class="flex items-center space-x-4">
            <span class="font-semibold text-gray-700 w-20">价格区间:</span>
            <div class="flex-grow pt-3 px-2">
                <div id="price-slider"></div>
            </div>
            <div class="flex items-center space-x-2 w-auto flex-shrink-0">
                <input type="number" id="price-min-input" class="w-20 p-1 border rounded text-center"
                       placeholder="最低价">
                <span class="text-gray-500">-</span>
                <input type="number" id="price-max-input" class="w-20 p-1 border rounded text-center"
                       placeholder="最高价">
                <span class="text-gray-500">万</span>
            </div>
            <button id="price-100-plus-btn"
                    class="ml-2 px-4 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-full flex-shrink-0">
                100万以上
            </button>
        </div>
        <div class="flex items-center space-x-4">
            <span class="font-semibold text-gray-700 w-20">选择品牌:</span>
            <div class="relative flex-grow">
                <button id="brand-filter-button" class="w-full text-left p-2 border rounded-md">所有品牌</button>
                <div id="brand-modal"></div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pt-4 border-t">
            <div>
                <label for="filter-power-type" class="block text-sm font-medium text-gray-700">动力类型</label>
                <select id="filter-power-type" data-filter-key="power_type"
                        class="filter-select mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="不限">不限</option>
                    <option value="纯电">纯电</option>
                    <option value="插电混动">插电混动</option>
                    <option value="增程式">增程式</option>
                    <option value="燃油">燃油</option>
                    <option value="油电混合">油电混合</option>
                    <option value="轻混系统">轻混系统</option>
                    <option value="氢能源">氢能源</option>
                </select>
            </div>
            <div>
                <label for="filter-body-type" class="block text-sm font-medium text-gray-700">车身类型</label>
                <select id="filter-body-type" data-filter-key="body_type"
                        class="filter-select mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="不限">不限</option>
                    <option value="SUV">SUV</option>
                    <option value="MPV">MPV</option>
                    <option value="轿车">轿车</option>
                    <option value="跑车">跑车</option>
                    <option value="皮卡">皮卡</option>
                    <option value="旅行车">旅行车</option>
                    <option value="掀背车">掀背车</option>
                    <option value="敞篷车">敞篷车</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div>
                <label for="filter-seat-count" class="block text-sm font-medium text-gray-700">座位数</label>
                <select id="filter-seat-count" data-filter-key="seat_count"
                        class="filter-select mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="不限">不限</option>
                    <option value="2座">2座</option>
                    <option value="4座">4座</option>
                    <option value="5座">5座</option>
                    <option value="6座">6座</option>
                    <option value="7座">7座</option>
                </select>
            </div>
            <div>
                <label for="filter-segment" class="block text-sm font-medium text-gray-700">车辆级别</label>
                <select id="filter-segment" data-filter-key="segment"
                        class="filter-select mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="不限">不限</option>
                    <option value="小型">小型</option>
                    <option value="紧凑型">紧凑型</option>
                    <option value="中型">中型</option>
                    <option value="中大型">中大型</option>
                    <option value="大型">大型</option>
                </select>
            </div>
        </div>
    </div>
</section>


<main class="max-w-6xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <p class="text-gray-600">共为您找到 <span id="total-hits" class="font-bold text-blue-600">0</span> 个相关车系
        </p>

        <div>
            <label for="sort-by" class="text-sm font-medium text-gray-700">排序方式：</label>
            <select id="sort-by"
                    class="border-gray-300 rounded-md shadow-sm text-sm p-2 bg-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="relevance">默认排序</option>
                <option value="price_asc">价格从低到高</option>
                <option value="price_desc">价格从高到低</option>
            </select>
        </div>

    </div>
    <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="pagination-container" class="mt-10 flex justify-center items-center space-x-2"></div>
</main>

<footer class="bg-gray-800 text-gray-300 text-center py-6 mt-10">
    © 2025 驭见 智能车辆搜索引擎 | 数据来源：易车
</footer>

<script src="https://unpkg.com/pinyin-pro@3.27.0/dist/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
<script src="config.js"></script>
<script>
    function setupNavbar() {
        const navbarContainer = document.getElementById('navbar-container');
        if (!navbarContainer) return;
        const nickname = localStorage.getItem('userNickname');
        const role = localStorage.getItem('userRole');
        let adminLinkHTML = '';
        if (role === 'admin' || role === 'core_admin') {
            adminLinkHTML = '<a href="admin.html" class="font-medium text-purple-600 hover:underline">管理后台</a>';
        }
        if (nickname) {
            navbarContainer.innerHTML = `
                <a href="车系.html" id="reset-homepage-link" class="font-bold text-blue-600 hover:underline">首页</a>
                <a href="favorites.html" class="hover:text-blue-500">我的收藏</a>
                <a href="compare.html" class="hover:text-blue-500">车型对比</a>
                <a href="about.html" class="hover:text-blue-500">关于</a>
                ${adminLinkHTML}<span class="font-semibold text-gray-700">欢迎, ${nickname}</span>
                <a href="profile.html" class="hover:text-blue-500">账户设置</a>
                <button id="logout-button-nav" class="text-gray-600 hover:text-red-500">退出登录</button>
            `;
            const logoutButton = document.getElementById('logout-button-nav');
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }
        } else {
            navbarContainer.innerHTML = `
                <a href="车系.html" id="reset-homepage-link" class="font-bold text-blue-600 hover:underline">首页</a>
                <a href="favorites.html" class="hover:text-blue-500">我的收藏</a>
                <a href="compare.html" class="hover:text-blue-500">车型对比</a>
                <a href="about.html" class="hover:text-blue-500">关于</a>
                <a href="login.html" class="font-medium text-blue-600 hover:underline">登录</a>
                <a href="register.html" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">注册</a>
            `;
        }
    }

    async function handleLogout() {
        localStorage.removeItem('userNickname');
        localStorage.removeItem('userRole');
        try {
            await fetch(`${API_BASE_URL}/auth/logout`, {
                method: 'POST',
                credentials: 'include'
            });
        } catch (error) {
            console.error("退出登录请求失败 (不影响本地退出):", error);
        }
        window.location.reload();
    }

    let currentPage = 1;
    const itemsPerPage = 12;

    const defaultFilters = {
        q: '',
        price_min: 0,
        price_max: 0,
        power_type: '不限',
        body_type: '不限',
        seat_count: '不限',
        segment: '不限',
        brand: '所有品牌',
        manufacturer: '所有厂商',
        sort_by: 'relevance'
    };

    let filters = {...defaultFilters};

    let brandManufacturerData = {};
    let groupedBrandsByPinyin = {};
    let hasFetchedData = false;
    let activeLetter = null;

    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function positionAutocomplete() {
        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('autocomplete-results');

        if (resultsContainer.style.display === 'block') {
            const rect = searchInput.getBoundingClientRect();
            resultsContainer.style.top = `${window.scrollY + rect.bottom}px`;
            resultsContainer.style.left = `${rect.left}px`;
            resultsContainer.style.width = `${rect.width}px`;
        }
    }

    async function fetchAutocomplete(query) {
        const resultsContainer = document.getElementById('autocomplete-results');
        const aiToggle = document.getElementById('ai-toggle');

        if (query.length < 1 || aiToggle.checked) {
            resultsContainer.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/search-models?q=${encodeURIComponent(query)}`);
            if (!response.ok) {
                resultsContainer.style.display = 'none';
                return;
            }
            const data = await response.json();

            if (data.length === 0) {
                resultsContainer.innerHTML = '<div class="p-3 text-gray-500 text-sm">未找到匹配项</div>';
            } else {

                let html = '';
                const uniqueSeries = new Map();

                data.forEach(model => {
                    const seriesName = model['车系名称'];
                    if (seriesName && !uniqueSeries.has(seriesName)) {
                        uniqueSeries.set(seriesName, true);
                    }
                });

                uniqueSeries.forEach((_, seriesName) => {
                    html += `
                        <div class="p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-100 autocomplete-item"
                             data-completion-text="${seriesName}">
                            <span class="font-medium text-gray-800">${seriesName}</span>
                            <span class="text-xs text-blue-500 font-medium ml-2">(车系)</span>
                        </div>
                    `;
                });

                if (uniqueSeries.size > 0) {
                    html += '<div class="autocomplete-separator"></div>';
                }

                data.forEach(model => {
                    const modelName = model['车型名称'];
                    const seriesName = model['车系名称'];

                    html += `
                        <div class="p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-100 autocomplete-item"
                             data-completion-text="${modelName}">
                            <span class="font-medium text-gray-800">${modelName}</span>
                            <span class="text-xs text-gray-400 ml-2">(车型)</span>
                            <span class="text-xs text-gray-500 block">隶属: ${seriesName} | ${model['基本信息_厂商指导价'] || ''}</span>
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;
            }
            resultsContainer.style.display = 'block';
            positionAutocomplete();
        } catch (e) {
            console.error("Autocomplete fetch failed:", e);
            resultsContainer.style.display = 'none';
        }
    }

    function renderLoadingSkeletons(count) {
        const resultsGrid = document.getElementById('results-grid');
        let skeletonHTML = '';
        for (let i = 0; i < count; i++) {
            skeletonHTML += `
            <div class="skeleton-card bg-white shadow rounded-lg p-4">
              <div class="rounded-lg mb-3 h-48 w-full object-cover bg-gray-200"></div>
              <div class="h-6 rounded bg-gray-200 w-3/4 mb-2"></div>
              <div class="flex flex-wrap gap-2 text-xs mb-3">
                <div class="h-4 rounded-full bg-gray-200 w-16"></div>
                <div class="h-4 rounded-full bg-gray-200 w-20"></div>
                <div class="h-4 rounded-full bg-gray-200 w-12"></div>
              </div>
              <div class="h-5 rounded bg-gray-200 w-24 mt-2"></div>
            </div>
            `;
        }
        resultsGrid.innerHTML = skeletonHTML;
    }

    function fetchAndRenderSeries() {
        try {
            sessionStorage.setItem('carFilters', JSON.stringify(filters));
        } catch (e) {
            console.error("无法保存筛选条件到 sessionStorage:", e);
        }

        renderLoadingSkeletons(itemsPerPage);

        fetch(`${API_BASE_URL}/search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({...filters, page: currentPage, per_page: itemsPerPage})
        })
            .then(response => response.ok ? response.json() : Promise.reject(`网络错误: ${response.status}`))
            .then(data => {
                if (data.error) throw new Error(data.error);
                renderCards(data.hits || []);
                renderPagination(data.total || 0);
                document.getElementById('total-hits').textContent = data.total || 0;
            })
            .catch(error => {
                console.error('获取车系数据出错:', error);
                document.getElementById('results-grid').innerHTML = `<p class="text-red-500 col-span-full">数据加载失败: ${error.message}</p>`;
            });
    }

    function updateFilterUIFromState() {
        if (!filters) return;
        const priceSlider = document.getElementById('price-slider');
        const priceMinInput = document.getElementById('price-min-input');
        const priceMaxInput = document.getElementById('price-max-input');
        const btn100Plus = document.getElementById('price-100-plus-btn');
        let minVal = filters.price_min || 0;
        let maxVal = filters.price_max || 100;
        if (filters.price_max === 0 && filters.price_min > 0) {
            maxVal = 100;
        } else if (filters.price_max === 0 && filters.price_min === 0) {
            maxVal = 100;
        }
        if (priceSlider && priceSlider.noUiSlider) {
            priceSlider.noUiSlider.set([minVal, maxVal]);
        }
        if (priceMinInput) priceMinInput.value = (minVal > 0) ? minVal : '';
        if (priceMaxInput) priceMaxInput.value = (maxVal === 100) ? '' : maxVal;
        if (filters.price_min === 100 && filters.price_max === 0) {
            btn100Plus.classList.add('bg-blue-500', 'text-white');
            btn100Plus.classList.remove('bg-gray-200', 'hover:bg-gray-300');
        } else {
            btn100Plus.classList.remove('bg-blue-500', 'text-white');
            btn100Plus.classList.add('bg-gray-200', 'hover:bg-gray-300');
        }
        const brandButton = document.getElementById('brand-filter-button');
        if (brandButton) {
            if (filters.brand && filters.brand !== '所有品牌') {
                if (filters.manufacturer && filters.manufacturer !== '所有厂商' && Array.isArray(filters.manufacturer) && filters.manufacturer.length > 0) {
                    brandButton.textContent = filters.manufacturer[0];
                } else {
                    brandButton.textContent = filters.brand;
                }
            } else {
                brandButton.textContent = '所有品牌';
            }
        }
        document.querySelectorAll('.filter-select').forEach(select => {
            const filterKey = select.dataset.filterKey;
            if (filters[filterKey]) {
                select.value = filters[filterKey];
            } else {
                select.value = '不限';
            }
        });

        const sortBySelect = document.getElementById('sort-by');
        if (sortBySelect) {
            sortBySelect.value = filters.sort_by || 'relevance';
        }
        const searchInput = document.getElementById('search-input');
        const clearSearchButton = document.getElementById('clear-search-button');
        if (searchInput) {
            searchInput.value = filters.q || '';
        }
        if (clearSearchButton) {
            if (filters.q && filters.q.length > 0) {
                clearSearchButton.style.display = 'flex';
            } else {
                clearSearchButton.style.display = 'none';
            }
        }
    }

    function groupBrandsByPinyin(brands) {
        const grouped = {};
        try {
            if (typeof pinyinPro === 'undefined' || typeof pinyinPro.pinyin !== 'function') {
                throw new Error("pinyin-pro 库加载失败或格式不正确");
            }
            brands.forEach(brandName => {
                const firstLetter = pinyinPro.pinyin(brandName, {
                    pattern: 'first',
                    toneType: 'none'
                }).charAt(0).toUpperCase();
                const letter = (firstLetter >= 'A' && firstLetter <= 'Z') ? firstLetter : '#';
                if (!grouped[letter]) grouped[letter] = [];
                grouped[letter].push(brandName);
            });
            return Object.keys(grouped).sort((a, b) => a === '#' ? 1 : b === '#' ? -1 : a.localeCompare(b))
                .reduce((acc, key) => {
                    acc[key] = grouped[key].sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                    return acc;
                }, {});
        } catch (error) {
            console.error(error);
            return {'#': brands.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'))};
        }
    }

    function renderBrandList() {
        const listContainer = document.getElementById('list-container');
        if (!listContainer) return;
        document.querySelectorAll('.alpha-nav button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.letter === activeLetter);
        });
        let listHTML = `<div class="list-item all-option" data-action="apply-filter" data-brand="所有品牌" data-manufacturer="所有厂商" data-display="所有品牌">所有品牌</div>`;
        const brandsToRender = activeLetter ? (groupedBrandsByPinyin[activeLetter] || []) : Object.keys(brandManufacturerData).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
        brandsToRender.forEach(brandName => {
            listHTML += `<div class="list-item" data-action="toggle-manufacturers" data-brand-name="${brandName}">${brandName}</div>`;
        });
        listContainer.innerHTML = listHTML;
    }

    function toggleManufacturerSublist(brandItem) {
        const existingSublist = document.querySelector('.manufacturer-sublist');
        const previouslyOpenItem = document.querySelector('.list-item.is-open');
        if (existingSublist) existingSublist.remove();
        if (previouslyOpenItem) previouslyOpenItem.classList.remove('is-open');
        if (previouslyOpenItem === brandItem) return;
        brandItem.classList.add('is-open');
        const brandName = brandItem.dataset.brandName;
        const manufacturers = brandManufacturerData[brandName] || [];
        const sublist = document.createElement('div');
        sublist.className = 'manufacturer-sublist';
        let sublistHTML = '';
        if (manufacturers.length > 1 || (manufacturers.length === 1 && manufacturers[0] !== brandName)) {
            sublistHTML += `<div class="list-item all-option" data-action="apply-filter" data-brand="${brandName}" data-manufacturer="所有厂商" data-display="全部${brandName}">全部${brandName}</div>`;
        }
        manufacturers.forEach(manufacturer => {
            sublistHTML += `<div class="list-item" data-action="apply-filter" data-brand="${brandName}" data-manufacturer='["${manufacturer}"]' data-display="${manufacturer}">${manufacturer}</div>`;
        });
        sublist.innerHTML = sublistHTML;
        brandItem.after(sublist);
    }

    function applyFilter(brand, manufacturerValue, displayText) {
        filters.brand = brand;
        try {
            filters.manufacturer = JSON.parse(manufacturerValue);
        } catch (e) {
            filters.manufacturer = manufacturerValue;
        }
        document.getElementById('brand-filter-button').textContent = displayText;
        document.getElementById('brand-modal').style.display = 'none';
        currentPage = 1;
        fetchAndRenderSeries();
    }

    function setupBrandFilter() {
        const modal = document.getElementById('brand-modal');
        const button = document.getElementById('brand-filter-button');
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = modal.style.display === 'block';
            modal.style.display = isVisible ? 'none' : 'block';
            if (!isVisible && !hasFetchedData) {
                modal.innerHTML = `<div class="grid grid-cols-12 h-full"><div class="col-span-1 alpha-nav" id="alpha-nav-container"></div><div class="col-span-11 list-container" id="list-container"><div class="p-4 text-center text-gray-500">正在加载...</div></div></div>`;
                fetch(`${API_BASE_URL}/get-brands-and-manufacturers`)
                    .then(response => response.ok ? response.json() : Promise.reject('无法加载品牌列表'))
                    .then(data => {
                        hasFetchedData = true;
                        brandManufacturerData = data;
                        groupedBrandsByPinyin = groupBrandsByPinyin(Object.keys(data));
                        const alphaContainer = document.getElementById('alpha-nav-container');
                        let alphaHTML = `<button class="active" data-letter="">全部</button>`;
                        Object.keys(groupedBrandsByPinyin).forEach(l => {
                            alphaHTML += `<button data-letter="${l}">${l}</button>`;
                        });
                        alphaContainer.innerHTML = alphaHTML;
                        activeLetter = null;
                        renderBrandList();
                    })
                    .catch(error => {
                        console.error('加载品牌列表失败:', error);
                        modal.innerHTML = `<div class="p-4 text-center text-red-500">加载失败，请重试</div>`;
                    });
            }
        });
        modal.addEventListener('click', (e) => {
            const target = e.target;
            e.stopPropagation();
            if (target.tagName === 'BUTTON' && target.parentElement.id === 'alpha-nav-container') {
                activeLetter = target.dataset.letter || null;
                renderBrandList();
                return;
            }
            if (target.classList.contains('list-item') && target.dataset.action) {
                const action = target.dataset.action;
                if (action === 'toggle-manufacturers') {
                    toggleManufacturerSublist(target);
                } else if (action === 'apply-filter') {
                    applyFilter(
                        target.dataset.brand,
                        target.dataset.manufacturer,
                        target.dataset.display
                    );
                }
            }
        });
        document.addEventListener('click', (e) => {
            if (!modal.contains(e.target) && !button.contains(e.target)) {
                modal.style.display = 'none';
            }
        });
    }

    function renderCards(cars) {
        const resultsGrid = document.getElementById('results-grid');

        if (cars.length === 0) {
            resultsGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
              <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10l.01.01" />
              </svg>
              <h3 class="mt-2 text-xl font-semibold text-gray-800">未找到相关车系</h3>
              <p class="mt-1 text-gray-500">请尝试减少筛选条件或更换关键词。</p>
            </div>
            `;
            return;
        }

        resultsGrid.innerHTML = '';
        cars.forEach(car => {
            const carData = car._source;
            if (!carData) return;
            const cardLink = document.createElement('a');
            cardLink.href = `details.html?series_name=${encodeURIComponent(carData['车系名称'])}`;
            cardLink.className = "block bg-white shadow rounded-lg p-4 flex flex-col justify-between relative transition-transform hover:scale-105";
            let tagsHTML = `<span class="bg-gray-100 text-gray-800 font-medium px-2.5 py-0.5 rounded-full">${carData['价格范围'] || '暂无价格'}</span>`;
            (carData['动力类型列表'] || []).forEach(type => {
                let colorClass = 'bg-gray-100 text-gray-800';
                if (['纯电', '氢能源'].includes(type)) colorClass = 'bg-green-100 text-green-800';
                else if (['插电混动', '增程式'].includes(type)) colorClass = 'bg-blue-100 text-blue-800';
                else if (['燃油', '油电混合', '轻混系统'].includes(type)) colorClass = 'bg-red-100 text-red-800';
                tagsHTML += `<span class="${colorClass} font-medium px-2.5 py-0.5 rounded-full">${type}</span>`;
            });
            (carData['车身类型列表'] || []).forEach(type => {
                tagsHTML += `<span class="bg-yellow-100 text-yellow-800 font-medium px-2.5 py-0.5 rounded-full">${type}</span>`;
            });
            (carData['座位数列表'] || []).forEach(type => {
                if (type) {
                    tagsHTML += `<span class="bg-purple-100 text-purple-800 font-medium px-2.5 py-0.5 rounded-full">${type}</span>`;
                }
            });
            (carData['级别列表'] || []).forEach(type => {
                if (type) {
                    tagsHTML += `<span class="bg-indigo-100 text-indigo-800 font-medium px-2.5 py-0.5 rounded-full">${type}</span>`;
                }
            });
            const manufacturerName = carData['厂商'] || '';
            const seriesName = carData['车系名称'] || '';
            const displayName = `${manufacturerName} ${seriesName}`.trim();
            cardLink.innerHTML = `
              <div>
                <img src="${carData['图片链接'] || 'https://via.placeholder.com/400x300.png?text=No+Image'}" alt="${displayName}" class="rounded-lg mb-3 h-48 w-full object-cover">
                <h3 class="text-xl font-semibold mb-2">${displayName}</h3>
                <div class="flex flex-wrap gap-2 text-xs mb-3">${tagsHTML}</div>
              </div>
              <span class="text-blue-500 hover:underline font-semibold self-start mt-2">查看详情 &rarr;</span>
            `;
            resultsGrid.appendChild(cardLink);
        });
    }

    function renderPagination(totalItems) {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (totalPages <= 1) return;
        const createButton = (text, page, isDisabled = false, isActive = false) => {
            const button = document.createElement('button');
            button.innerHTML = text;
            button.disabled = isDisabled;
            button.className = `px-4 py-2 text-sm rounded-md ${isActive ? 'bg-blue-500 text-white' : 'bg-white border hover:bg-gray-100'} ${isDisabled ? 'cursor-not-allowed opacity-50' : ''}`;
            if (!isDisabled) {
                button.onclick = () => {
                    currentPage = page;
                    fetchAndRenderSeries();
                    window.scrollTo(0, 0);
                };
            }
            return button;
        };
        paginationContainer.appendChild(createButton('上一页', currentPage - 1, currentPage === 1));
        let hasStartEllipsis = false;
        let hasEndEllipsis = false;
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                paginationContainer.appendChild(createButton(i, i, false, i === currentPage));
            } else if (i < currentPage - 2 && !hasStartEllipsis) {
                paginationContainer.insertAdjacentHTML('beforeend', `<span class="px-2">...</span>`);
                hasStartEllipsis = true;
            } else if (i > currentPage + 2 && !hasEndEllipsis) {
                paginationContainer.insertAdjacentHTML('beforeend', `<span class="px-2">...</span>`);
                hasEndEllipsis = true;
            }
        }
        paginationContainer.appendChild(createButton('下一页', currentPage + 1, currentPage === totalPages));
        const jumpHTML = `
            <span class="ml-4 text-sm text-gray-600">共 ${totalPages} 页，跳至</span>
            <input type="number" id="page-jump-input" class="w-16 p-2 border rounded text-center text-sm" min="1" max="${totalPages}" placeholder="页码">
            <button id="page-jump-btn" class="ml-2 px-4 py-2 text-sm rounded-md bg-white border hover:bg-gray-100">跳转</button>
        `;
        paginationContainer.insertAdjacentHTML('beforeend', jumpHTML);
        const jumpButton = document.getElementById('page-jump-btn');
        const jumpInput = document.getElementById('page-jump-input');
        const handleJump = () => {
            let page = parseInt(jumpInput.value);
            if (!isNaN(page) && page >= 1 && page <= totalPages) {
                currentPage = page;
                fetchAndRenderSeries();
                window.scrollTo(0, 0);
            } else {
                alert(`请输入 1 到 ${totalPages} 之间的有效页码`);
                jumpInput.value = '';
            }
        };
        if (jumpButton) jumpButton.addEventListener('click', handleJump);
        if (jumpInput) jumpInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') handleJump();
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        setupNavbar();
        const resetHomepageLink = document.getElementById('reset-homepage-link');
        resetHomepageLink.addEventListener('click', (e) => {
            e.preventDefault();
            console.log("重置首页状态...");
            sessionStorage.removeItem('carFilters');
            window.location.href = '车系.html';
        });

        const savedFilters = sessionStorage.getItem('carFilters');
        if (savedFilters) {
            try {
                const parsedFilters = JSON.parse(savedFilters);
                filters = {...defaultFilters, ...parsedFilters};
            } catch (e) {
                console.error("加载筛选条件失败", e);
                filters = {...defaultFilters};
                sessionStorage.removeItem('carFilters');
            }
        } else {
            filters = {...defaultFilters};
        }

        const priceSlider = document.getElementById('price-slider');
        const priceMinInput = document.getElementById('price-min-input');
        const priceMaxInput = document.getElementById('price-max-input');
        const btn100Plus = document.getElementById('price-100-plus-btn');
        let initialMax = (filters.price_max === 0 || filters.price_max === null) ? 100 : filters.price_max;
        if (filters.price_min === 100 && (filters.price_max === 0 || filters.price_max === null)) initialMax = 100;

        noUiSlider.create(priceSlider, {
            start: [filters.price_min || 0, initialMax],
            connect: true, range: {'min': 0, 'max': 100}, step: 1,
            format: {to: v => Math.round(v), from: v => Number(v)}
        });

        priceSlider.noUiSlider.on('update', values => {
            const [min, max] = values;
            if (document.activeElement !== priceMinInput) priceMinInput.value = (min > 0) ? min : '';
            if (document.activeElement !== priceMaxInput) priceMaxInput.value = (max === 100) ? '' : max;
        });

        priceSlider.noUiSlider.on('change', values => {
            const [min, max] = values;
            btn100Plus.classList.remove('bg-blue-500', 'text-white');
            btn100Plus.classList.add('bg-gray-200', 'hover:bg-gray-300');
            filters.price_min = min;
            filters.price_max = (max === 100) ? 0 : max;
            currentPage = 1;
            fetchAndRenderSeries();
        });

        function syncInputsToSlider() {
            btn100Plus.classList.remove('bg-blue-500', 'text-white');
            btn100Plus.classList.add('bg-gray-200', 'hover:bg-gray-300');
            let minVal = priceMinInput.value === '' ? 0 : parseInt(priceMinInput.value);
            let maxVal = priceMaxInput.value === '' ? 100 : parseInt(priceMaxInput.value);
            minVal = isNaN(minVal) || minVal < 0 ? 0 : minVal;
            maxVal = isNaN(maxVal) || maxVal < 0 ? 100 : maxVal;
            if (minVal > 100) minVal = 100;
            if (maxVal > 100) maxVal = 100;
            if (minVal > maxVal) maxVal = minVal;
            priceSlider.noUiSlider.set([minVal, maxVal], false);
            filters.price_min = minVal;
            filters.price_max = (maxVal === 100) ? 0 : maxVal;
            currentPage = 1;
            fetchAndRenderSeries();
        }

        priceMinInput.addEventListener('change', syncInputsToSlider);
        priceMaxInput.addEventListener('change', syncInputsToSlider);

        btn100Plus.addEventListener('click', () => {
            filters.price_min = 100;
            filters.price_max = 0;
            priceSlider.noUiSlider.set([100, 100]);
            priceMinInput.value = 100;
            priceMaxInput.value = '';
            btn100Plus.classList.add('bg-blue-500', 'text-white');
            btn100Plus.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            currentPage = 1;
            fetchAndRenderSeries();
        });

        document.querySelectorAll('.filter-select').forEach(select => {
            select.addEventListener('change', e => {
                const filterKey = e.target.dataset.filterKey;
                const filterValue = e.target.value;
                filters[filterKey] = filterValue;
                currentPage = 1;
                fetchAndRenderSeries();
            });
        });

        document.getElementById('sort-by').addEventListener('change', (e) => {
            filters.sort_by = e.target.value;
            currentPage = 1;
            fetchAndRenderSeries();
        });

        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('search-input');
        const aiToggle = document.getElementById('ai-toggle');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const clearSearchButton = document.getElementById('clear-search-button');

        aiToggle.addEventListener('change', () => {
            if (aiToggle.checked) {
                searchInput.placeholder = "输入您的购车需求 (如: 预算20万的家用SUV)";
                autocompleteResults.style.display = 'none';
            } else {
                searchInput.placeholder = "传统搜索 (如 奥迪A4L)";
            }
        });

        const handleSearchOrAI = () => {
            const query = searchInput.value.trim();
            autocompleteResults.style.display = 'none';

            if (aiToggle.checked) {
                const targetUrl = query ? `second.html?initial_prompt=${encodeURIComponent(query)}` : 'second.html';
                window.location.href = targetUrl;
            } else {
                filters.q = query;
                currentPage = 1;
                fetchAndRenderSeries();
            }
        };

        searchButton.onclick = handleSearchOrAI;
        searchInput.onkeydown = e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSearchOrAI();
            }
        };
        const debouncedFetch = debounce(fetchAutocomplete, 300);
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim();
            debouncedFetch(query);

            if (query.length > 0) {
                clearSearchButton.style.display = 'flex';
            } else {
                clearSearchButton.style.display = 'none';
            }
        });

        window.addEventListener('resize', positionAutocomplete);
        window.addEventListener('scroll', positionAutocomplete);

        searchInput.addEventListener('blur', () => {
            setTimeout(() => {
                autocompleteResults.style.display = 'none';
            }, 200);
        });

        searchInput.addEventListener('focus', () => {
            if (searchInput.value.trim().length > 0) {
                debouncedFetch(searchInput.value.trim());
            }
        });

        autocompleteResults.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const item = e.target.closest('.autocomplete-item');
            if (item) {
                const completionText = item.dataset.completionText;
                if (completionText) {
                    searchInput.value = completionText;
                    autocompleteResults.style.display = 'none';

                    filters.q = completionText;
                    currentPage = 1;
                    fetchAndRenderSeries();

                    clearSearchButton.style.display = 'flex';
                }
            }
        });

        clearSearchButton.addEventListener('click', () => {
            searchInput.value = '';
            filters.q = '';
            clearSearchButton.style.display = 'none';
            autocompleteResults.style.display = 'none';
            searchInput.focus();
        });

        updateFilterUIFromState();
        setupBrandFilter();
        if (filters.q) {
            searchInput.value = filters.q;
            clearSearchButton.style.display = 'flex';
        } else {
            searchInput.value = '';
            clearSearchButton.style.display = 'none';
        }
        renderLoadingSkeletons(itemsPerPage);
        fetchAndRenderSeries();
    });
</script>
</body>
</html>