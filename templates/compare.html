<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è½¦å‹å¯¹æ¯” - é©­Â·è§æ™ºèƒ½æœç´¢å¼•æ“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pinyin-pro@3.27.0/dist/index.js"></script>
    <style>
        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: inherit;
        }

        thead th:first-child {
            z-index: 20;
        }

        tbody tr:hover td {
            background-color: #f9fafb;
        }

        tbody tr:hover td:first-child {
            background-color: #f9fafb;
        }

        tbody tr:nth-child(even):hover td {
            background-color: #f3f4f6;
        }

        tbody tr:nth-child(even):hover td:first-child {
            background-color: #f3f4f6;
        }

        #add-model-panel .list-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }

        #add-model-panel .list-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        #add-model-panel .list-item:last-child {
            border-bottom: none;
        }

        #add-model-panel .list-item:hover {
            background-color: #f9fafb;
        }

        #add-model-panel .list-item.active {
            background-color: #EFF6FF;
            color: #2563EB;
            font-weight: 600;
        }

        #add-model-panel .list-item.added {
            background-color: #F0FDF4;
            color: #166534;
            cursor: not-allowed;
        }

        .favorite-btn.favorited svg {
            fill: currentColor;
        }

        .favorite-btn:not(.favorited) svg {
            fill: none;
        }

        .ai-summary-content h1,
        .ai-summary-content h2,
        .ai-summary-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }

        .ai-summary-content ul,
        .ai-summary-content ol {
            list-style-position: inside;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }

        .ai-summary-content li {
            margin-bottom: 0.5rem;
        }

        .ai-summary-content p {
            margin-bottom: 1rem;
        }

        .ai-summary-content strong,
        .ai-summary-content b {
            font-weight: 600;
            color: #111827;
        }

        .ai-summary-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .ai-summary-content th,
        .ai-summary-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
        }

        .ai-summary-content th {
            background-color: #f9fafb;
        }

        @keyframes pulse {
            50% {
                opacity: 0.5;
            }
        }

        .skeleton-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-100">

<header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-50">
    <h1 class="text-3xl font-bold text-blue-600">é©­Â·è§</h1>
    <nav id="navbar-container" class="space-x-6 text-gray-700">
        <a href="è½¦ç³».html" class="hover:text-blue-500">é¦–é¡µ</a>
        <span class="text-gray-400">åŠ è½½ä¸­...</span>
    </nav>
</header>
<section class="max-w-7xl mx-auto mt-8 px-4">
    <div class="flex justify-between items-center mb-2">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">è½¦å‹å‚æ•°å¯¹æ¯”</h2>
            <p class="text-gray-600">ä¸€ç›®äº†ç„¶ï¼Œå¸®ä½ å¿«é€Ÿé€‰å‡ºæœ€åˆé€‚çš„é‚£ä¸€æ¬¾</p>
        </div>
        <button id="clear-compare-list"
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition hidden">
            æ¸…ç©ºå¯¹æ¯”åˆ—è¡¨
        </button>
    </div>

    <div id="ai-summary-section" class="mt-6 bg-white rounded-lg shadow-lg" style="display: none;">
        <div id="ai-summary-trigger" class="p-6 flex justify-between items-center cursor-pointer">
            <h3 class="text-2xl font-bold text-gray-800">ğŸ¤– AI æ™ºèƒ½å¯¹æ¯”æ€»ç»“</h3>
            <button id="ai-summary-toggle-button"
                    class="text-blue-600 hover:text-blue-800 font-semibold py-1 px-3 rounded-lg">
                ç‚¹æ­¤ç”Ÿæˆ &darr;
            </button>
        </div>
        <div id="ai-compare-container" class="px-6 pb-6 border-t border-gray-200" style="display: none;">
            <div id="ai-compare-content" class="mt-6 text-gray-700 leading-relaxed ai-summary-content">
            </div>
        </div>
    </div>

</section>

<section id="add-model-section" class="max-w-7xl mx-auto mt-4 px-4">
    <button id="toggle-add-panel-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium transition">
        + æ·»åŠ æ–°è½¦å‹
    </button>
    <div id="add-model-panel" class="hidden mt-4 p-4 bg-white rounded-lg shadow-md">
        <div class="mb-4">
            <label for="model-search-input" class="block text-sm font-medium text-gray-700">å¿«é€Ÿæœç´¢è½¦å‹</label>
            <div class="flex mt-1">
                <input type="text" id="model-search-input" placeholder="è¾“å…¥è½¦å‹ã€è½¦ç³»æˆ–å“ç‰Œ..."
                       class="flex-grow p-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500">
                <button id="model-search-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 rounded-r-md">æœç´¢
                </button>
            </div>
            <div id="model-search-results" class="list-container mt-2 hidden"></div>
        </div>
        <p class="block text-sm font-medium text-gray-700 mb-2">æˆ–æŒ‰å“ç‰Œæµè§ˆ</p>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <h4 class="font-semibold mb-1">1. é€‰æ‹©å“ç‰Œ</h4>
                <div id="brand-list" class="list-container">
                    <p class="p-2 text-gray-500">åŠ è½½ä¸­...</p>
                </div>
            </div>
            <div>
                <h4 class="font-semibold mb-1">2. é€‰æ‹©å‚å•†</h4>
                <div id="mfg-list" class="list-container">
                    <p class="p-2 text-gray-500">è¯·å…ˆé€‰æ‹©å“ç‰Œ</p>
                </div>
            </div>
            <div>
                <h4 class="font-semibold mb-1">3. é€‰æ‹©è½¦ç³»</h4>
                <div id="series-list" class="list-container">
                    <p class="p-2 text-gray-500">è¯·å…ˆé€‰æ‹©å‚å•†</p>
                </div>
            </div>
            <div>
                <h4 class="font-semibold mb-1">4. é€‰æ‹©è½¦å‹</h4>
                <div id="model-list" class="list-container">
                    <p class="p-2 text-gray-500">è¯·å…ˆé€‰æ‹©è½¦ç³»</p>
                </div>
            </div>
        </div>
    </div>
</section>


<main id="compare-container" class="max-w-7xl mx-auto mt-6 bg-white shadow-lg rounded-2xl overflow-x-auto">
    <div id="compare-initial-state" class="p-10 text-center text-gray-500">
        <p>æ­£åœ¨åŠ è½½å¯¹æ¯”æ•°æ®...</p>
    </div>
    <table id="compare-table" class="min-w-full text-sm text-gray-700 border-collapse hidden">
        <thead id="compare-thead" class="bg-blue-600 text-white align-top">
        </thead>
        <tbody id="compare-tbody">
        </tbody>
    </table>
</main>

<footer class="mt-10 text-center text-gray-500 pb-6">
    Â© 2025 é©­è§ æ™ºèƒ½è½¦è¾†æœç´¢å¼•æ“ | æ•°æ®æ¥æºï¼šæ˜“è½¦
</footer>
<script src="config.js"></script>
<script>
    let brandManufacturerData = {};
    let groupedBrandsByPinyin = {};
    let lastAddPanelAction = {type: null, value: null};
    let isUserLoggedIn = false;
    let userFavoritesList = [];

    function setupNavbar() {
        const navbarContainer = document.getElementById('navbar-container');
        if (!navbarContainer) return;

        const nickname = localStorage.getItem('userNickname');
        const role = localStorage.getItem('userRole');
        let adminLinkHTML = '';
        if (role === 'admin' || role === 'core_admin') {
            adminLinkHTML = '<a href="admin.html" class="font-medium text-purple-600 hover:underline">ç®¡ç†åå°</a>';
        }
        if (nickname) {
            navbarContainer.innerHTML = `
                <a href="è½¦ç³».html" id="reset-homepage-link" class="hover:text-blue-500">é¦–é¡µ</a>
                <a href="favorites.html" class="hover:text-blue-500">æˆ‘çš„æ”¶è—</a>
                <a href="compare.html" class="font-bold text-blue-600 hover:underline">è½¦å‹å¯¹æ¯”</a>
                <a href="javascript:history.back()" id="nav-back-link" class="hover:text-blue-500">&larr; è¿”å›</a>
                <a href="about.html" class="hover:text-blue-500">å…³äº</a>
                ${adminLinkHTML}<span class="font-semibold text-gray-700">æ¬¢è¿, ${nickname}</span>
                <a href="profile.html" class="hover:text-blue-500">è´¦æˆ·è®¾ç½®</a>
                <button id="logout-button-nav" class="text-gray-600 hover:text-red-500">é€€å‡ºç™»å½•</button>
            `;
            const logoutButton = document.getElementById('logout-button-nav');
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }
        } else {
            navbarContainer.innerHTML = `
                <a href="è½¦ç³».html" id="reset-homepage-link" class="hover:text-blue-500">é¦–é¡µ</a>
                <a href="favorites.html" class="hover:text-blue-500">æˆ‘çš„æ”¶è—</a>
                <a href="compare.html" class="font-bold text-blue-600 hover:underline">è½¦å‹å¯¹æ¯”</a>
                <a href="javascript:history.back()" id="nav-back-link" class="hover:text-blue-500">&larr; è¿”å›</a>
                <a href="about.html" class="hover:text-blue-500">å…³äº</a>
                <a href="login.html" class="font-medium text-blue-600 hover:underline">ç™»å½•</a>
                <a href="register.html" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">æ³¨å†Œ</a>
            `;
        }
    }

    async function handleLogout() {
        localStorage.removeItem('userNickname');
        localStorage.removeItem('userRole');
        try {
            await fetch(`${API_BASE_URL}/auth/logout`, {
                method: 'POST',
                credentials: 'include'
            });
        } catch (error) {
            console.error("é€€å‡ºç™»å½•è¯·æ±‚å¤±è´¥ (ä¸å½±å“æœ¬åœ°é€€å‡º):", error);
        }

        window.location.reload();
    }

    async function loadUserFavorites() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/favorites`, {
                method: 'GET',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'}
            });

            if (response.status === 200) {
                userFavoritesList = await response.json();
                isUserLoggedIn = true;
                console.log("ç”¨æˆ·æ”¶è—åˆ—è¡¨åŠ è½½æˆåŠŸ:", userFavoritesList);
            } else {
                isUserLoggedIn = false;
                userFavoritesList = [];
                console.log("ç”¨æˆ·æœªç™»å½•æˆ–è·å–æ”¶è—å¤±è´¥ã€‚");
            }
        } catch (e) {
            console.error("æ— æ³•è¿æ¥åˆ°æ”¶è—å¤¹API:", e);
            isUserLoggedIn = false;
            userFavoritesList = [];
        }
    }

    async function apiAddFavorite(modelId, seriesName) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/favorites/add`, {
                method: 'POST',
                credentials: 'include', // ã€ã€ã€å…³é”®ã€‘ã€‘ã€‘
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model_id: modelId, series_name: seriesName})
            });
            if (!response.ok) return false;
            userFavoritesList.push({id: modelId, series: seriesName});
            return true;
        } catch (e) {
            console.error("æ·»åŠ æ”¶è—å¤±è´¥:", e);
            return false;
        }
    }

    async function apiRemoveFavorite(modelId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/favorites/remove`, {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model_id: modelId})
            });
            if (!response.ok) return false;
            userFavoritesList = userFavoritesList.filter(item => item.id !== modelId);
            return true;
        } catch (e) {
            console.error("ç§»é™¤æ”¶è—å¤±è´¥:", e);
            return false;
        }
    }

    async function handleFavoriteClick(buttonEl) {
        if (!isUserLoggedIn) {
            alert("è¯·å…ˆç™»å½•åå†ä½¿ç”¨æ”¶è—åŠŸèƒ½ã€‚");
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
            return;
        }

        const modelId = decodeURIComponent(buttonEl.dataset.modelId);
        const seriesName = decodeURIComponent(buttonEl.dataset.seriesName);

        const isFavorited = userFavoritesList.some(item => item.id === modelId);

        const favIconFavorited = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>';
        const favIconRegular = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>';

        if (isFavorited) {

            buttonEl.title = 'åŠ å…¥æ”¶è—';
            buttonEl.classList.remove('favorited', 'text-red-300', 'bg-red-100');
            buttonEl.classList.add('text-blue-300', 'hover:text-white');
            buttonEl.innerHTML = favIconRegular;

            const success = await apiRemoveFavorite(modelId);
            if (!success) {
                buttonEl.title = 'ç§»é™¤æ”¶è—';
                buttonEl.classList.add('favorited', 'text-red-300', 'bg-red-100');
                buttonEl.classList.remove('text-blue-300', 'hover:text-white');
                buttonEl.innerHTML = favIconFavorited;
            }
        } else {
            buttonEl.title = 'ç§»é™¤æ”¶è—';
            buttonEl.classList.add('favorited', 'text-red-300', 'bg-red-100');
            buttonEl.classList.remove('text-blue-300', 'hover:text-white');
            buttonEl.innerHTML = favIconFavorited;

            const success = await apiAddFavorite(modelId, seriesName);
            if (!success) {
                buttonEl.title = 'åŠ å…¥æ”¶è—';
                buttonEl.classList.remove('favorited', 'text-red-300', 'bg-red-100');
                buttonEl.classList.add('text-blue-300', 'hover:text-white');
                buttonEl.innerHTML = favIconRegular;
            }
        }
    }

    function getComparisonList() {
        try {
            const list = sessionStorage.getItem('comparisonList');
            return list ? JSON.parse(list) : [];
        } catch (e) {
            console.error("æ— æ³•è§£æå¯¹æ¯”åˆ—è¡¨:", e);
            return [];
        }
    }

    function addToComparison(modelId, modelName, seriesName) {
        if (!modelId || !seriesName) {
            console.error("æ·»åŠ åˆ°å¯¹æ¯”å¤±è´¥ï¼šmodelId æˆ– seriesName ä¸ºç©º");
            return false;
        }
        let list = getComparisonList();
        const exists = list.some(item => item.id === modelId);
        if (!exists) {
            list.push({id: modelId, series: seriesName});
            sessionStorage.setItem('comparisonList', JSON.stringify(list));
            console.log(`å·²æ·»åŠ  ${modelName} (${modelId}, ${seriesName})`);
            return true;
        }
        return false;
    }

    function removeFromComparison(modelId) {
        let list = getComparisonList();
        list = list.filter(item => item.id !== modelId);
        sessionStorage.setItem('comparisonList', JSON.stringify(list));
        console.log(`å·²ç§»é™¤ ${modelId}`);
        loadPage();

        document.getElementById('ai-summary-section').style.display = 'none';
        document.getElementById('ai-compare-container').style.display = 'none';
        document.getElementById('ai-compare-content').innerHTML = '';
        document.getElementById('ai-summary-toggle-button').innerHTML = 'ç‚¹æ­¤ç”Ÿæˆ &darr;';


        if (lastAddPanelAction.type === 'search' && lastAddPanelAction.value) {
            console.log(`æ™ºèƒ½åˆ·æ–°æœç´¢: ${lastAddPanelAction.value}`);
            handleSearch(lastAddPanelAction.value);
        } else if (lastAddPanelAction.type === 'browse' && lastAddPanelAction.value) {
            console.log(`æ™ºèƒ½åˆ·æ–°æµè§ˆ: ${lastAddPanelAction.value}`);
            loadModels(lastAddPanelAction.value);
        }
    }

    document.getElementById('clear-compare-list').addEventListener('click', () => {
        sessionStorage.removeItem('comparisonList');
        loadPage();

        document.getElementById('ai-summary-section').style.display = 'none';
        document.getElementById('ai-compare-container').style.display = 'none';
        document.getElementById('ai-compare-content').innerHTML = '';
        document.getElementById('ai-summary-toggle-button').innerHTML = 'ç‚¹æ­¤ç”Ÿæˆ &darr;';

        resetPanel('brand');
        const resultsContainer = document.getElementById('model-search-results');
        resultsContainer.innerHTML = '';
        resultsContainer.classList.add('hidden');
        document.getElementById('model-search-input').value = '';
        lastAddPanelAction = {type: null, value: null};
    });

    function renderEmptyState(message) {
        const table = document.getElementById('compare-table');
        const initialState = document.getElementById('compare-initial-state');
        const clearButton = document.getElementById('clear-compare-list');

        document.getElementById('ai-summary-section').style.display = 'none';
        document.getElementById('ai-compare-container').style.display = 'none';

        table.classList.add('hidden');
        initialState.innerHTML = `<p class="p-10 text-center text-gray-500">${message}</p>`;
        initialState.classList.remove('hidden');
        clearButton.classList.add('hidden');
    }

    async function fetchAllModelData(modelItems) {
        const fetchPromises = modelItems.map(item =>
            fetch(`${API_BASE_URL}/get-model-config?model_id=${encodeURIComponent(item.id)}&series_name=${encodeURIComponent(item.series)}`)
                .then(res => {
                    if (!res.ok) throw new Error(`è½¦å‹ ${item.id} åŠ è½½å¤±è´¥`);
                    return res.json();
                })
        );
        const results = await Promise.allSettled(fetchPromises);
        const successfulData = results
            .filter(res => res.status === 'fulfilled')
            .map(res => res.value);
        const failedModels = results
            .filter(res => res.status === 'rejected')
            .length;
        if (failedModels > 0) {
            alert(`${failedModels} ä¸ªè½¦å‹æ•°æ®åŠ è½½å¤±è´¥ï¼Œå¯èƒ½å·²è¢«ç§»é™¤ã€‚`);
        }
        return successfulData;
    }

    function renderComparisonTable(modelsData) {
        const table = document.getElementById('compare-table');
        const thead = document.getElementById('compare-thead');
        const tbody = document.getElementById('compare-tbody');
        const initialState = document.getElementById('compare-initial-state');
        const clearButton = document.getElementById('clear-compare-list');

        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (modelsData.length === 0) {
            renderEmptyState("æ‚¨å°šæœªæ·»åŠ ä»»ä½•è½¦å‹åˆ°å¯¹æ¯”åˆ—è¡¨ã€‚è¯·å…ˆæµè§ˆè½¦å‹å¹¶ç‚¹å‡»â€œåŠ å…¥å¯¹æ¯”â€ã€‚");
            return;
        }

        let headerHTML = '<tr><th class="p-4 text-left font-semibold text-lg" style="min-width: 150px;">å¯¹æ¯”é¡¹</th>';
        modelsData.forEach(model => {
            const modelId = model['è½¦å‹åç§°'];
            const seriesName = model['è½¦ç³»åç§°'];
            const isFavorited = userFavoritesList.some(item => item.id === modelId);

            let favBtnHTML;
            if (!isUserLoggedIn) {
                favBtnHTML = `
                    <a href="login.html?redirect=${encodeURIComponent(window.location.href)}"
                       title="ç™»å½•ä»¥æ”¶è—"
                       class="favorite-btn p-1.5 rounded-full text-blue-300 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                    </a>
                 `;
            } else {
                const favBtnClasses = isFavorited
                    ? 'favorite-btn p-1.5 rounded-full text-red-300 bg-red-100 favorited'
                    : 'favorite-btn p-1.5 rounded-full text-blue-300 hover:text-white';
                const favIconHTML = isFavorited
                    ? '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>'
                    : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 016.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>';
                const favTitle = isFavorited ? 'ç§»é™¤æ”¶è—' : 'åŠ å…¥æ”¶è—';

                favBtnHTML = `
                    <button class="${favBtnClasses}"
                            data-model-id="${encodeURIComponent(modelId)}"
                            data-series-name="${encodeURIComponent(seriesName)}"
                            title="${favTitle}">
                        ${favIconHTML}
                    </button>
                `;
            }


            headerHTML += `
                <th class="p-4 text-center" style="min-width: 250px;">
                    <img src="${model['å›¾ç‰‡é“¾æ¥'] || 'https://via.placeholder.com/400x300.png?text=No+Image'}" alt="${model['è½¦å‹åç§°']}"
                         class="w-full max-w-xs aspect-video object-cover rounded-lg mb-2 mx-auto">
                    <p class="font-semibold text-base">${model['è½¦å‹åç§°'] || 'æœªçŸ¥è½¦å‹'}</p>
                    <p class="font-normal text-sm mt-1">${model['åŸºæœ¬ä¿¡æ¯_å‚å•†æŒ‡å¯¼ä»·'] || 'ä»·æ ¼æœªçŸ¥'}</p>
                    <div class="flex justify-center items-center space-x-2 mt-2">
                        ${favBtnHTML} <button class="remove-compare-btn text-red-300 hover:text-white text-xs px-2 py-1 bg-red-800/20 hover:bg-red-700/50 rounded-md"
                                data-model-id="${modelId}">
                            Ã— ç§»é™¤å¯¹æ¯”
                        </button>
                    </div>
                </th>
            `;
        });
        headerHTML += '</tr>';
        thead.innerHTML = headerHTML;

        const ignoreKeys = new Set([
            'is_koubei_row', 'price_numeric', 'å›¾ç‰‡é“¾æ¥', 'è½¦ç³»åç§°', 'è½¦å‹åç§°',
            'å“ç‰Œ', 'æ‰€æœ‰è¯„ä»·', 'å¹³å‡è¯„åˆ†', 'è¯„ä»·æ•°é‡',
            'è¯„ä»·æ¡æ•°',
            'åŸºæœ¬ä¿¡æ¯_å‚å•†æŒ‡å¯¼ä»·', 'brand_website_url'
        ]);
        const preferredGroupOrder = [
            'åŸºæœ¬ä¿¡æ¯', 'è½¦èº«', 'åŠ¨åŠ›ç³»ç»Ÿ', 'å‘åŠ¨æœº', 'ç”µæœº', 'ç”µæ± /è¡¥èƒ½', 'å˜é€Ÿç®±', 'åº•ç›˜è½¬å‘', 'è½¦è½®åˆ¶åŠ¨',
            'ä¸»åŠ¨å®‰å…¨', 'è¾…åŠ©/æ“æ§é…ç½®', 'å¤–éƒ¨é…ç½®', 'å†…éƒ¨é…ç½®', 'åº§æ¤…é…ç½®',
            'å¤šåª’ä½“é…ç½®', 'æ™ºèƒ½äº’è”', 'ç¯å…‰é…ç½®', 'ç»ç’ƒ/åè§†é•œ', 'ç©ºè°ƒ/å†°ç®±'
        ];
        const allSpecGroups = {};
        modelsData.forEach(model => {
            for (const key in model) {
                if (ignoreKeys.has(key) || model[key] === null || model[key] === '') continue;
                let groupName = 'å…¶ä»–ä¿¡æ¯';
                let specName = key;
                if (key.includes('_')) {
                    const parts = key.split('_');
                    groupName = parts[0];
                    specName = parts.slice(1).join('_');
                }
                if (!allSpecGroups[groupName]) {
                    allSpecGroups[groupName] = new Set();
                }
                allSpecGroups[groupName].add(specName);
            }
        });

        let bodyHTML = '';
        for (const groupName in allSpecGroups) {
            if (!preferredGroupOrder.includes(groupName)) {
                preferredGroupOrder.push(groupName);
            }
        }
        preferredGroupOrder.forEach(groupName => {
            if (allSpecGroups[groupName]) {
                bodyHTML += `<tr class="bg-blue-50"><td class="p-3 font-bold text-blue-700" colspan="${modelsData.length + 1}">${groupName}</td></tr>`;
                allSpecGroups[groupName].forEach(specName => {
                    const fullKey = (groupName === 'å…¶ä»–ä¿¡æ¯') ? specName : `${groupName}_${specName}`;
                    let allEmpty = true;
                    for (const model of modelsData) {
                        if (model[fullKey]) {
                            allEmpty = false;
                            break;
                        }
                    }
                    if (allEmpty) return;
                    bodyHTML += `<tr class="border-b border-gray-200 even:bg-gray-50">`;
                    bodyHTML += `<td class="p-3 font-semibold text-gray-800 bg-white">${specName}</td>`;
                    modelsData.forEach(model => {
                        const value = model[fullKey] || 'â€”';
                        bodyHTML += `<td class="p-3 text-center">${value}</td>`;
                    });
                    bodyHTML += `</tr>`;
                });
            }
        });
        tbody.innerHTML = bodyHTML;

        initialState.classList.add('hidden');
        table.classList.remove('hidden');
        clearButton.classList.remove('hidden');
        document.querySelectorAll('.remove-compare-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modelId = e.target.dataset.modelId;
                removeFromComparison(modelId);
            });
        });
        thead.addEventListener('click', (e) => {
            const favButton = e.target.closest('.favorite-btn');
            if (favButton && favButton.tagName === 'BUTTON') {
                e.preventDefault();
                e.stopPropagation();
                handleFavoriteClick(favButton);
            }
        });

        const aiSummarySection = document.getElementById('ai-summary-section');
        const aiSummaryTrigger = document.getElementById('ai-summary-trigger');
        const aiSummaryContainer = document.getElementById('ai-compare-container');
        const aiSummaryToggleButton = document.getElementById('ai-summary-toggle-button');
        const aiCompareContent = document.getElementById('ai-compare-content');

        let aiCompareLoaded = false;

        if (modelsData.length >= 2) {
            aiSummarySection.style.display = 'block';

            aiSummaryTrigger.onclick = async () => {
                const isHidden = aiSummaryContainer.style.display === 'none';

                if (isHidden) {
                    aiSummaryContainer.style.display = 'block';
                    aiSummaryToggleButton.innerHTML = 'æ”¶èµ·æ€»ç»“ &uarr;';

                    if (!aiCompareLoaded) {
                        aiCompareLoaded = true;

                        aiCompareContent.innerHTML = `
                            <div class="skeleton-pulse p-4 text-center text-gray-600">
                                <p class="font-semibold text-lg mb-2">ğŸ¤– AI å¯¹æ¯”æ€»ç»“ç”Ÿæˆä¸­...</p>
                                <div class="h-3 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
                                <div class="h-3 bg-gray-200 rounded w-1/2 mx-auto"></div>
                            </div>`;

                        const keyFields = [
                            'è½¦å‹åç§°', 'åŸºæœ¬ä¿¡æ¯_å‚å•†æŒ‡å¯¼ä»·', 'åŠ¨åŠ›ç±»å‹', 'å‘åŠ¨æœº_æ’é‡[L]',
                            'å‘åŠ¨æœº_æœ€å¤§åŠŸç‡[kW]', 'ç”µæœº_æ€»åŠŸç‡[kW]', 'ç”µæ± /è¡¥èƒ½_CLTCçº¯ç”µç»­èˆªé‡Œç¨‹[km]',
                            'è½¦èº«_é•¿*å®½*é«˜[mm]', 'è½¦èº«_è½´è·[mm]', 'è½¦èº«_åº§ä½æ•°',
                            'è¾…åŠ©é©¾é©¶ç¡¬ä»¶_é©¾é©¶è¾…åŠ©çº§åˆ«', 'åº§æ¤…é…ç½®_ç¬¬ä¸€æ’åº§æ¤…åŠŸèƒ½',
                            'è½¦æœº/äº’è”_ä¸­æ§å±å°ºå¯¸[è‹±å¯¸]', 'åº•ç›˜è½¬å‘_é©±åŠ¨å½¢å¼'
                        ];

                        const slimModelsData = modelsData.map(model => {
                            const slimModel = {};
                            for (const key of keyFields) {
                                if (model[key] && model[key] !== 'â€”') {
                                    slimModel[key] = model[key];
                                }
                            }
                            return slimModel;
                        });

                        try {
                            const response = await fetch(`${API_BASE_URL}/ai_compare`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(slimModelsData)
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || `HTTP ${response.status} é”™è¯¯`);
                            }

                            const data = await response.json();
                            const formattedSummary = data.summary.replace(/\n/g, '<br>');
                            aiCompareContent.innerHTML = formattedSummary;

                        } catch (error) {
                            console.error("AI å¯¹æ¯”å¤±è´¥:", error);
                            aiCompareContent.innerHTML = `<p class="text-red-500 font-semibold">âŒ AI æ€»ç»“ç”Ÿæˆå¤±è´¥ï¼š${error.message}</p>`;
                            aiCompareLoaded = false;
                        }
                    }
                } else {
                    aiSummaryContainer.style.display = 'none';
                    aiSummaryToggleButton.innerHTML = aiCompareLoaded ? 'å±•å¼€æ€»ç»“ &darr;' : 'ç‚¹æ­¤ç”Ÿæˆ &darr;';
                }
            };
        } else {
            aiSummarySection.style.display = 'none';
        }
    }

    function groupBrandsByPinyin(brands) {
        const grouped = {};
        try {
            if (typeof pinyinPro === 'undefined' || typeof pinyinPro.pinyin !== 'function') {
                throw new Error("pinyin-pro åº“åŠ è½½å¤±è´¥");
            }
            brands.forEach(brandName => {
                const firstLetter = pinyinPro.pinyin(brandName, {
                    pattern: 'first',
                    toneType: 'none'
                }).charAt(0).toUpperCase();
                const letter = (firstLetter >= 'A' && firstLetter <= 'Z') ? firstLetter : '#';
                if (!grouped[letter]) grouped[letter] = [];
                grouped[letter].push(brandName);
            });
            return Object.keys(grouped).sort((a, b) => a === '#' ? 1 : b === '#' ? -1 : a.localeCompare(b))
                .reduce((acc, key) => {
                    acc[key] = grouped[key].sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                    return acc;
                }, {});
        } catch (error) {
            console.error(error);
            return {'#': brands.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'))};
        }
    }

    function resetPanel(fromStep = 'brand') {
        if (fromStep === 'brand') {
            document.getElementById('mfg-list').innerHTML = '<p class="p-2 text-gray-500">è¯·å…ˆé€‰æ‹©å“ç‰Œ</p>';
        }
        if (fromStep === 'brand' || fromStep === 'mfg') {
            document.getElementById('series-list').innerHTML = '<p class="p-2 text-gray-500">è¯·å…ˆé€‰æ‹©å‚å•†</p>';
        }
        if (fromStep === 'brand' || fromStep === 'mfg' || fromStep === 'series') {
            document.getElementById('model-list').innerHTML = '<p class="p-2 text-gray-500">è¯·å…ˆé€‰æ‹©è½¦ç³»</p>';
        }
    }

    async function loadBrands() {
        const listContainer = document.getElementById('brand-list');
        try {
            const response = await fetch(`${API_BASE_URL}/get-brands-and-manufacturers`);
            if (!response.ok) throw new Error('æ— æ³•åŠ è½½å“ç‰Œåˆ—è¡¨');
            const data = await response.json();
            brandManufacturerData = data;
            groupedBrandsByPinyin = groupBrandsByPinyin(Object.keys(data));
            let listHTML = '';
            Object.keys(groupedBrandsByPinyin).forEach(letter => {
                listHTML += `<div class="p-2 bg-gray-100 font-semibold text-gray-600">${letter}</div>`;
                groupedBrandsByPinyin[letter].forEach(brandName => {
                    listHTML += `<div class="list-item" data-brand="${brandName}">${brandName}</div>`;
                });
            });
            listContainer.innerHTML = listHTML;
            listContainer.querySelectorAll('.list-item').forEach(item => {
                item.addEventListener('click', () => {
                    listContainer.querySelectorAll('.list-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const brandName = item.dataset.brand;
                    loadManufacturers(brandName, brandManufacturerData[brandName]);
                    document.getElementById('model-search-results').classList.add('hidden');
                    lastAddPanelAction = {type: null, value: null};
                });
            });
        } catch (e) {
            listContainer.innerHTML = `<p class="p-2 text-red-500">${e.message}</p>`;
        }
    }

    function loadManufacturers(brandName, manufacturers) {
        resetPanel('brand');
        const listContainer = document.getElementById('mfg-list');
        if (!manufacturers || manufacturers.length === 0) {
            listContainer.innerHTML = '<p class="p-2 text-gray-500">è¯¥å“ç‰Œä¸‹æ— å‚å•†</p>';
            return;
        }
        let listHTML = `<div class="list-item" data-brand="${brandName}" data-mfg="æ‰€æœ‰å‚å•†" style="font-weight: 600; color: #2563EB;">å…¨éƒ¨å‚å•†</div>`;
        manufacturers.forEach(mfgName => {
            listHTML += `<div class="list-item" data-brand="${brandName}" data-mfg="${mfgName}">${mfgName}</div>`;
        });
        listContainer.innerHTML = listHTML;
        listContainer.querySelectorAll('.list-item').forEach(item => {
            item.addEventListener('click', () => {
                listContainer.querySelectorAll('.list-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                loadSeries(item.dataset.brand, item.dataset.mfg);
            });
        });
    }

    async function loadSeries(brandName, mfgName) {
        resetPanel('mfg');
        const listContainer = document.getElementById('series-list');
        listContainer.innerHTML = '<p class="p-2 text-gray-500">åŠ è½½ä¸­...</p>';
        try {
            const response = await fetch(`${API_BASE_URL}/get-series-by-manufacturer?brand=${encodeURIComponent(brandName)}&manufacturer=${encodeURIComponent(mfgName)}`);
            if (!response.ok) throw new Error('æ— æ³•åŠ è½½è½¦ç³»åˆ—è¡¨');
            const data = await response.json();
            if (data.length === 0) {
                listContainer.innerHTML = '<p class="p-2 text-gray-500">è¯¥å‚å•†ä¸‹æ— è½¦ç³»</p>';
                return;
            }
            let listHTML = '';
            data.forEach(seriesName => {
                listHTML += `<div class="list-item" data-series="${seriesName}">${seriesName}</div>`;
            });
            listContainer.innerHTML = listHTML;
            listContainer.querySelectorAll('.list-item').forEach(item => {
                item.addEventListener('click', () => {
                    listContainer.querySelectorAll('.list-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    loadModels(item.dataset.series);
                });
            });
        } catch (e) {
            listContainer.innerHTML = `<p class="p-2 text-red-500">${e.message}</p>`;
        }
    }

    async function loadModels(seriesName) {
        lastAddPanelAction = {type: 'browse', value: seriesName};
        resetPanel('series');
        const listContainer = document.getElementById('model-list');
        listContainer.innerHTML = '<p class="p-2 text-gray-500">åŠ è½½ä¸­...</p>';
        const comparisonList = getComparisonList();
        try {
            const response = await fetch(`${API_BASE_URL}/details?series_name=${encodeURIComponent(seriesName)}&per_page=100`);
            if (!response.ok) throw new Error('æ— æ³•åŠ è½½è½¦å‹åˆ—è¡¨');
            const data = await response.json();
            if (!data.hits || data.hits.length === 0) {
                listContainer.innerHTML = '<p class="p-2 text-gray-500">è¯¥è½¦ç³»ä¸‹æ— è½¦å‹</p>';
                return;
            }
            let listHTML = '';
            data.hits.forEach(model => {
                const modelId = model['è½¦å‹åç§°'];
                const modelPrice = model['åŸºæœ¬ä¿¡æ¯_å‚å•†æŒ‡å¯¼ä»·'] || '';
                const isAdded = comparisonList.some(item => item.id === modelId);
                listHTML += `
                    <div class="list-item ${isAdded ? 'added' : ''}"
                         data-model-id="${modelId}"
                         data-model-name="${model['è½¦å‹åç§°']}">
                        <span class="font-medium">${model['è½¦å‹åç§°']}</span>
                        <span class="text-xs text-gray-500 block">${modelPrice}</span>
                        <span class="status-text text-xs font-bold text-green-700 block">${isAdded ? 'å·²åœ¨å¯¹æ¯”' : ''}</span>
                    </div>`;
            });
            listContainer.innerHTML = listHTML;
            listContainer.querySelectorAll('.list-item:not(.added)').forEach(item => {
                item.addEventListener('click', () => {
                    const success = addToComparison(item.dataset.modelId, item.dataset.modelName, seriesName);
                    if (success) {
                        item.classList.add('added');
                        const statusEl = item.querySelector('.status-text');
                        if (statusEl) statusEl.textContent = 'å·²åœ¨å¯¹æ¯”';
                        loadPage();
                    }
                });
            });
        } catch (e) {
            listContainer.innerHTML = `<p class="p-2 text-red-500">${e.message}</p>`;
        }
    }

    async function handleSearch(externalQuery = null) {
        let query;
        if (externalQuery !== null) {
            query = externalQuery;
        } else {
            query = document.getElementById('model-search-input').value.trim();
            lastAddPanelAction = {type: 'search', value: query};
            resetPanel('brand');
        }
        const resultsContainer = document.getElementById('model-search-results');
        if (!query) {
            resultsContainer.innerHTML = '';
            resultsContainer.classList.add('hidden');
            lastAddPanelAction = {type: null, value: null};
            return;
        }
        resultsContainer.innerHTML = '<p class="p-2 text-gray-500">æœç´¢ä¸­...</p>';
        resultsContainer.classList.remove('hidden');
        const comparisonList = getComparisonList();
        try {
            const response = await fetch(`${API_BASE_URL}/search-models?q=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error('æœç´¢å¤±è´¥');
            const data = await response.json();
            if (data.length === 0) {
                resultsContainer.innerHTML = '<p class="p-2 text-gray-500">æœªæ‰¾åˆ°ç›¸å…³è½¦å‹</p>';
                return;
            }
            let listHTML = '';
            data.forEach(model => {
                const modelId = model['è½¦å‹åç§°'];
                const seriesName = model['è½¦ç³»åç§°'];
                const isAdded = comparisonList.some(item => item.id === modelId);
                listHTML += `
                    <div class="list-item ${isAdded ? 'added' : ''}"
                         data-model-id="${modelId}"
                         data-model-name="${model['è½¦å‹åç§°']}"
                         data-series-name="${seriesName}"> <span class="font-medium">${model['è½¦å‹åç§°']}</span>
                        <span class="text-xs text-gray-500 block">${model['è½¦ç³»åç§°']} | ${model['åŸºæœ¬ä¿¡æ¯_å‚å•†æŒ‡å¯¼ä»·'] || ''}</span>
                        <span class="status-text text-xs font-bold text-green-700 block">${isAdded ? 'å·²åœ¨å¯¹æ¯”' : ''}</span>
                    </div>`;
            });
            resultsContainer.innerHTML = listHTML;
            resultsContainer.querySelectorAll('.list-item:not(.added)').forEach(item => {
                item.addEventListener('click', () => {
                    const success = addToComparison(item.dataset.modelId, item.dataset.modelName, item.dataset.seriesName);
                    if (success) {
                        item.classList.add('added');
                        const statusEl = item.querySelector('.status-text');
                        if (statusEl) statusEl.textContent = 'å·²åœ¨å¯¹æ¯”';
                        loadPage();
                    }
                });
            });
        } catch (e) {
            resultsContainer.innerHTML = `<p class="p-2 text-red-500">${e.message}</p>`;
        }
    }

    function initAddModelPanel() {
        document.getElementById('toggle-add-panel-btn').addEventListener('click', (e) => {
            const panel = document.getElementById('add-model-panel');
            const isHidden = panel.classList.contains('hidden');
            if (isHidden) {
                panel.classList.remove('hidden');
                e.target.textContent = 'âˆ’ æ”¶èµ·æ·»åŠ é¢æ¿';
                if (Object.keys(brandManufacturerData).length === 0) {
                    loadBrands();
                }
            } else {
                panel.classList.add('hidden');
                e.target.textContent = '+ æ·»åŠ æ–°è½¦å‹';
            }
        });
        document.getElementById('model-search-btn').addEventListener('click', () => handleSearch(null));
        document.getElementById('model-search-input').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') handleSearch(null);
        });
    }

    async function loadPage() {
        setupNavbar();
        await loadUserFavorites();
        const modelItems = getComparisonList();
        if (modelItems.length === 0) {
            renderEmptyState("æ‚¨å°šæœªæ·»åŠ ä»»ä½•è½¦å‹åˆ°å¯¹æ¯”åˆ—è¡¨ã€‚è¯·å…ˆæµè§ˆè½¦å‹å¹¶ç‚¹å‡»â€œåŠ å…¥å¯¹æ¯”â€ã€‚");
        } else {
            const initialState = document.getElementById('compare-initial-state');
            initialState.innerHTML = '<p class="p-10 text-center text-gray-500">æ­£åœ¨åŠ è½½å¯¹æ¯”æ•°æ®...</p>';
            initialState.classList.remove('hidden');
            document.getElementById('compare-table').classList.add('hidden');

            const modelsData = await fetchAllModelData(modelItems);
            if (modelsData.length > 0) {
                renderComparisonTable(modelsData);
            } else {
                renderEmptyState("æ‚¨é€‰æ‹©çš„è½¦å‹å‡æ— æ³•åŠ è½½æ•°æ®ã€‚");
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadPage();
        initAddModelPanel();
    });

</script>
</body>
</html>